<!-- public/appraisal.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Complete Appraisal</title>
  <!-- Load Google Identity Services library -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Link to the external CSS file -->
  <style>
    @import url('css/styles.css');
  </style>  
  <!-- Additional page-specific styles -->
  <style>
    /* [Tus estilos existentes...] */
  </style>
</head>
<body>

  <!-- Dashboard Title -->
  <div class="dashboard-title">Appraiser's Dashboard</div>
  
  <!-- Logout Button -->
  <button id="logout-button" class="logout-button">Logout</button>
  <!-- Div to display the user's name -->
  <div id="user-name" class="user-name" style="display: none;"></div>
  
  <div class="container">
    <!-- Back Button -->
    <a href="index.html" class="back-button" aria-label="Go back to the list of pending appraisals">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
      </svg>
      Back
    </a>

    <!-- Logo -->
    <div class="logo">
      <a href="https://www.appraisily.com/" target="_blank">
        <img src="https://www.appraisily.com/wp-content/uploads/2023/12/cropped-appraisily.com_a_logo_for_an_online_art_and_antiques_appraisal__a8888b1f-2dbb-479e-9833-09c6263f0892.webp" alt="Appraisily Logo">
      </a>
    </div>

    <!-- Title -->
    <div class="title">Complete Appraisal</div>

    <!-- Success/Error Messages -->
    <div id="message"></div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Loader Container -->
      <div id="loader-container" style="display: none;">
        <div id="loader"></div>
        <div id="loader-message">Processing appraisal...</div>
      </div>

      <!-- Descriptions Container -->
      <div class="descriptions-container">
        <!-- Customer Description -->
        <div id="customer-description">
          <div class="description-title">Customer Description:</div>
          <div class="description-text" id="customer-description-text"></div>
        </div>

        <!-- AI Description -->
        <div id="ia-description">
          <div class="description-title">AI Description:</div>
          <div class="description-text" id="ia-description-text"></div>
        </div>
      </div>

      <!-- Images Container -->
      <div class="images-container" id="images-container">
        <!-- Images will be inserted here -->
      </div>

      <!-- Form to Complete Appraisal -->
      <form id="appraisal-form">
        <label for="appraisalValue">Appraisal Value:</label>
        <input type="number" id="appraisalValue" name="appraisalValue" required />

        <label for="description">Appraiser Description:</label>
        <textarea id="description" name="description" rows="6" required></textarea>

        <button type="submit" class="submit-button">Submit</button>
      </form>
    </div>

    <!-- Footer -->
    <div class="footer">
      © <span id="current-year"></span> Appraisily. All rights reserved.
    </div>

   <script>
      let appraisalDataGlobal = null;

      // Update the year in the footer
      document.getElementById('current-year').textContent = new Date().getFullYear();

      // Get the appraisal ID from the URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const appraisalId = urlParams.get('id');

      if (!appraisalId) {
        alert('Appraisal ID not provided.');
        window.location.href = 'index.html';
      }

      // Function to show messages
      function showMessage(type, text) {
        const messageDiv = document.getElementById('message');
        messageDiv.className = type === 'success' ? 'success' : 'error';
        messageDiv.innerText = text;
        messageDiv.style.display = 'block';
      }

      // Function to hide messages
      function hideMessage() {
        const messageDiv = document.getElementById('message');
        messageDiv.style.display = 'none';
      }

      // Function to show the loader
      function showLoader(message) {
        const loaderContainer = document.getElementById('loader-container');
        const loaderMessage = document.getElementById('loader-message');
        loaderMessage.innerText = message;
        loaderContainer.style.display = 'flex';
      }

      // Function to hide the loader
      function hideLoader() {
        const loaderContainer = document.getElementById('loader-container');
        loaderContainer.style.display = 'none';
      }

      // Function to load the appraisal details
      function loadAppraisalDetails() {
        // Show the loader
        showLoader('Fetching appraisal details...');
        hideMessage();

        fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}/list`, {
          method: 'GET',
          credentials: 'include'
        })
        .then(res => {
          hideLoader();
          if (res.status === 401 || res.status === 403) {
            throw new Error('You are not authenticated. Please log in.');
          } else if (res.status === 404) {
            throw new Error('Appraisal not found.');
          }
          return res.json();
        })
        .then(data => {
          if (!data || typeof data !== 'object') {
            throw new Error('Invalid appraisal data received.');
          }

          // Assign the data to the global variable
          appraisalDataGlobal = data;

          // Display descriptions
          const customerDescriptionText = document.getElementById('customer-description-text');
          customerDescriptionText.innerText = data.customerDescription || 'Not available';

          const iaDescriptionText = document.getElementById('ia-description-text');
          iaDescriptionText.innerText = data.iaDescription || 'Not available';

          // Display images with labels
          const imagesContainer = document.getElementById('images-container');
          imagesContainer.innerHTML = '';

          if (data.images) {
            // Main Image
            if (data.images.main) {
              const mainImageWrapper = document.createElement('div');
              mainImageWrapper.className = 'image-wrapper';

              const mainImage = document.createElement('img');
              mainImage.src = data.images.main;
              mainImage.alt = 'Main Image';
              mainImageWrapper.appendChild(mainImage);

              const mainLabel = document.createElement('div');
              mainLabel.className = 'image-label';
              mainLabel.innerText = 'Main Image';
              mainImageWrapper.appendChild(mainLabel);

              imagesContainer.appendChild(mainImageWrapper);
            }

            // Age Image
            if (data.images.age) {
              const ageImageWrapper = document.createElement('div');
              ageImageWrapper.className = 'image-wrapper';

              const ageImage = document.createElement('img');
              ageImage.src = data.images.age;
              ageImage.alt = 'Age Image';
              ageImageWrapper.appendChild(ageImage);

              const ageLabel = document.createElement('div');
              ageLabel.className = 'image-label';
              ageLabel.innerText = 'Age Image';
              ageImageWrapper.appendChild(ageLabel);

              imagesContainer.appendChild(ageImageWrapper);
            }

            // Signature Image
            if (data.images.signature) {
              const signatureImageWrapper = document.createElement('div');
              signatureImageWrapper.className = 'image-wrapper';

              const signatureImage = document.createElement('img');
              signatureImage.src = data.images.signature;
              signatureImage.alt = 'Signature Image';
              signatureImageWrapper.appendChild(signatureImage);

              const signatureLabel = document.createElement('div');
              signatureLabel.className = 'image-label';
              signatureLabel.innerText = 'Signature Image';
              signatureImageWrapper.appendChild(signatureLabel);

              imagesContainer.appendChild(signatureImageWrapper);
            }
          }

          showMessage('success', 'Appraisal details loaded successfully.');
        })
        .catch(err => {
          console.error('Error fetching appraisal details:', err);
          showMessage('error', err.message || 'Error fetching appraisal details.');
          hideLoader();

          // Redirect to index if not authenticated
          if (err.message.includes('not authenticated')) {
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 2000);
          }
        });
      }

      // Handle logout
      function logout() {
        showLoader('Logging out...');
        hideMessage();

        fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/logout', {
          method: 'POST',
          credentials: 'include'
        })
        .then(res => res.json())
        .then(data => {
          hideLoader();

          if (data.success) {
            // Remove user name from localStorage
            localStorage.removeItem('userName');

            // Hide user name display
            document.getElementById('user-name').style.display = 'none';

            // Show success message
            showMessage('success', 'Successfully logged out.');

            // Redirect to login page or index
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 2000);
          } else {
            // Handle logout failure
            showMessage('error', 'Error logging out. Please try again.');
          }
        })
        .catch(err => {
          hideLoader();
          console.error('Error during logout:', err);
          showMessage('error', 'Error logging out. Please try again.');
        });
      }

      // Add event listener to logout button
      document.getElementById('logout-button').addEventListener('click', logout);

      // Function to handle the form submission and initiate the server-side process
      document.getElementById('appraisal-form').addEventListener('submit', async function(event) {
        event.preventDefault();

        const appraisalValueInput = document.getElementById('appraisalValue');
        const appraisalValue = appraisalValueInput.value.trim();
        const appraiserDescription = document.getElementById('description').value.trim();

        // Client-side validation for Appraisal Value
        if (appraisalValue === '') {
          showMessage('error', 'Missing Appraisal Value.');
          return;
        }

        // Validate that appraisalValue is a positive number
        if (isNaN(appraisalValue) || Number(appraisalValue) <= 0) {
          showMessage('error', 'Appraisal Value must be a positive number.');
          return;
        }

        // Show loader
        showLoader('Submitting appraisal...');
        hideMessage();

        try {
          // *** MODIFICACIÓN AQUÍ ***
          // Enviar la solicitud al Appraisers Task Queue en lugar del backend actual
          const response = await fetch(`https://appraisers-task-queue-856401495068.us-central1.run.app/api/tasks`, { // Actualiza el endpoint
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              // 'Authorization': 'Bearer YOUR_TOKEN_HERE' // Descomenta y reemplaza si tu servicio requiere autenticación
            },
            // credentials: 'include', // Comenta o elimina si no es necesario
            body: JSON.stringify({ 
              appraisalId: appraisalId, // Asegúrate de enviar el ID de la evaluación si es necesario
              appraisalValue: appraisalValue,
              description: appraiserDescription
            })
          });

          const responseData = await response.json();

          hideLoader();

          if (!responseData.success) { // Asegúrate de que el Task Queue responda con { success: true/false, message: '...' }
            throw new Error(responseData.message || 'Error completing the appraisal.');
          }

          // Show success message
          showMessage('success', 'Appraisal submitted to the Task Queue successfully.');

          // Opcional: Redirigir de vuelta al dashboard después de un retraso
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 5000);

        } catch (error) {
          hideLoader();
          console.error('Error during appraisal process:', error);
          showMessage('error', error.message || 'An unexpected error occurred during the appraisal process.');
        }
      });

      // Function to show the user's name
      function showUserName(name) {
        const userNameDiv = document.getElementById('user-name');
        userNameDiv.textContent = `Logged in as ${name}`;
        userNameDiv.style.display = 'block';
      }

      // On window load, load the appraisal details
      window.onload = () => {
        loadAppraisalDetails();
        // Show the logout button
        document.getElementById('logout-button').style.display = 'block';

        // Show the user's name if available
        const userName = localStorage.getItem('userName');
        if (userName) {
          showUserName(userName);
        }
      };
    </script>

</body>
</html>
