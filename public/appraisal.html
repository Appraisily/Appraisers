<!-- public/appraisal.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Complete Appraisal</title>
  <!-- Load Google Identity Services library -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Link to the external CSS file -->
  <style>
    @import url('css/styles.css');
  </style>  
  <!-- Additional page-specific styles -->
  <style>
    /* Main Content Container */
    .main-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Descriptions Container */
    .descriptions-container {
      max-width: 800px;
      margin-bottom: 30px;
      text-align: left; /* Align text to the left for better readability */
    }

    .description-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333333;
    }

    .description-text {
      font-size: 16px;
      line-height: 1.5;
      color: #555555;
      margin-bottom: 20px;
      white-space: pre-wrap; /* Preserve line breaks */
    }

    /* Images Container */
    .images-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 30px;
      gap: 20px;
    }

    .image-wrapper {
      text-align: center;
    }

    .image-wrapper img {
      max-width: 100%;
      height: auto;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      max-width: 300px; /* Limit the maximum width of images */
    }

    .image-label {
      font-size: 14px;
      color: #333333;
      margin-top: 5px;
    }

    /* Logout Button */
    .logout-button {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background-color: #ffffff;
      color: #d9534f;
      border: 2px solid #d9534f;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease, color 0.3s ease;
      z-index: 1000;
    }

    .logout-button:hover {
      background-color: #d9534f;
      color: #ffffff;
    }

    /* Appraisal Form Styles */
    #appraisal-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 600px;
      margin-bottom: 30px;
    }

    #appraisal-form label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333333;
      text-align: left;
      width: 100%;
    }

    #appraisal-form input,
    #appraisal-form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }

    #appraisal-form button.submit-button {
      background-color: #007bff;
      color: #ffffff;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      align-self: center;
    }

    #appraisal-form button.submit-button:hover {
      background-color: #0056b3;
    }

    /* Success/Error Messages */
    #message {
      max-width: 800px;
      margin: 20px auto;
      padding: 15px 20px;
      border-radius: 4px;
      display: none;
      font-size: 16px;
    }

    #message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    #message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* Steps List */
    .steps-list {
      list-style: none;
      padding: 0;
      margin-top: 20px; /* Espaciado superior para separarlo del spinner */
      width: 100%;
      max-width: 600px;
    }

    .steps-list li.step {
      font-size: 16px;
      color: #444444; /* Anthracite gray */
      margin-bottom: 10px;
    }

    .steps-list li.step.active {
      font-weight: bold;
      color: #000000; /* Black */
    }

    .steps-list li.step.completed {
      color: #000000; /* Black */
    }

    /* Loader and Fetching Message */
    #loader-container {
      display: none; /* Hidden by default */
      flex-direction: column;
      align-items: center;
      margin: 20px 0;
    }

    #loader {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    #loader-message {
      font-size: 16px;
      color: #555555;
      margin-bottom: 20px;
    }

    .steps-list {
      display: none; /* Hidden by default */
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Footer */
    .footer {
      margin-top: auto;
      padding: 20px;
      text-align: center;
      font-size: 12px;
      color: #777777;
    }

    .footer a {
      color: #007bff;
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* Action Button */
    .action-button {
      padding: 8px 16px;
      background-color: #007bff;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
      text-decoration: none;
    }

    .action-button:hover {
      background-color: #0056b3;
    }

    /* Styles for user name display */
    .user-name {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      background-color: #ffffff;
      color: #28a745;
      border: 2px solid #28a745;
      border-radius: 4px;
      font-size: 14px;
      z-index: 1000;
    }

    .back-button svg {
      margin-right: 5px;
      vertical-align: middle;
    }

    /* Estilo para pasos fallidos */
    .steps-list li.step.error {
      color: #dc3545; /* Rojo para errores */
    }
  </style>
</head>
<body>

  <!-- Dashboard Title -->
  <div class="dashboard-title">Appraiser's Dashboard</div>
  
  <!-- Logout Button -->
  <button id="logout-button" class="logout-button">Logout</button>
  <!-- Div to display the user's name -->
  <div id="user-name" class="user-name" style="display: none;"></div>
  
  <div class="container">
    <!-- Back Button -->
    <a href="index.html" class="back-button" aria-label="Go back to the list of pending appraisals">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
      </svg>
      Back
    </a>

    <!-- Logo -->
    <div class="logo">
      <a href="https://www.appraisily.com/" target="_blank">
        <img src="https://www.appraisily.com/wp-content/uploads/2023/12/cropped-appraisily.com_a_logo_for_an_online_art_and_antiques_appraisal__a8888b1f-2dbb-479e-9833-09c6263f0892.webp" alt="Appraisily Logo">
      </a>
    </div>

    <!-- Title -->
    <div class="title">Complete Appraisal</div>

    <!-- Success/Error Messages -->
    <div id="message"></div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Loader Container -->
      <div id="loader-container">
        <div id="loader"></div>
        <div id="loader-message">Submitting Appraisal...</div>
        <!-- Lista de Pasos -->
        <ul class="steps-list">
          <li class="step active">Paso 1: Set Appraisal Value</li>
          <li class="step pending">Paso 2: Merge Descriptions with OpenAI</li>
          <li class="step pending">Paso 3: Update Post Title in WordPress</li>
          <li class="step pending">Paso 4: Insert WordPress Template</li>
          <li class="step pending">Paso 5: Building PDF</li>
          <li class="step pending">Paso 6: Send Email to Customer</li>
          <li class="step pending">Paso 7: Mark Appraisal as Completed</li>
        </ul>
      </div>

      <!-- Descriptions Container -->
      <div class="descriptions-container">
        <!-- Customer Description -->
        <div id="customer-description">
          <div class="description-title">Customer Description:</div>
          <div class="description-text" id="customer-description-text"></div>
        </div>

        <!-- AI Description -->
        <div id="ia-description">
          <div class="description-title">AI Description:</div>
          <div class="description-text" id="ia-description-text"></div>
        </div>
      </div>

      <!-- Images Container -->
      <div class="images-container" id="images-container">
        <!-- Images will be inserted here -->
      </div>

      <!-- Form to Complete Appraisal -->
      <form id="appraisal-form">
        <label for="appraisalValue">Appraisal Value:</label>
        <input type="number" id="appraisalValue" name="appraisalValue" required />

        <label for="description">Appraiser Description:</label>
        <textarea id="description" name="description" rows="6" required></textarea>

        <button type="submit" class="submit-button">Submit</button>
      </form>
    </div>

    <!-- Footer -->
    <div class="footer">
      © <span id="current-year"></span> Appraisily. All rights reserved.
    </div>

  <script>
    // Actualizar el año en el footer
    document.getElementById('current-year').textContent = new Date().getFullYear();

    // Obtener el ID del appraisal de los parámetros de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const appraisalId = urlParams.get('id');

    if (!appraisalId) {
      alert('Appraisal ID no proporcionado.');
      window.location.href = 'index.html';
    }

    // Definir los pasos
    const steps = [
      'Paso 1: Set Appraisal Value',
      'Paso 2: Merge Descriptions with OpenAI',
      'Paso 3: Update Post Title in WordPress',
      'Paso 4: Insert WordPress Template',
      'Paso 5: Building PDF',
      'Paso 6: Send Email to Customer',
      'Paso 7: Mark Appraisal as Completed'
    ];
    let currentStepIndex = 0; // Índice del paso actual (0-based)

    // Obtener referencias a los pasos de la lista
    const stepElements = document.querySelectorAll('.steps-list li.step');

    // Función para mostrar el paso actual
    function showCurrentStepMessage() {
      stepElements.forEach((step, index) => {
        if (index === currentStepIndex) {
          step.classList.add('active');
          step.classList.remove('completed', 'pending', 'error');
        } else if (index < currentStepIndex) {
          step.classList.add('completed');
          step.classList.remove('active', 'pending', 'error');
        } else {
          step.classList.add('pending');
          step.classList.remove('active', 'completed', 'error');
        }
      });
    }

    // Inicializar los pasos al cargar la página
    showCurrentStepMessage();

    // Función para completar el paso actual y avanzar al siguiente
    function completeCurrentStep() {
      if (currentStepIndex < stepElements.length) {
        console.log(`Completing step ${currentStepIndex + 1}: ${steps[currentStepIndex]}`);
        // Marcar el paso actual como completado
        stepElements[currentStepIndex].classList.add('completed');
        stepElements[currentStepIndex].classList.remove('active', 'pending', 'error');

        // Avanzar al siguiente paso
        currentStepIndex++;
        if (currentStepIndex < stepElements.length) {
          // Marcar el siguiente paso como activo
          stepElements[currentStepIndex].classList.add('active');
          stepElements[currentStepIndex].classList.remove('completed', 'pending', 'error');
        }
      }
    }

    // Función para marcar el paso actual como fallido y avanzar al siguiente
    function failCurrentStep(errorMessage) {
      if (currentStepIndex < stepElements.length) {
        console.error(`Failing step ${currentStepIndex + 1}: ${steps[currentStepIndex]} - Error: ${errorMessage}`);
        // Marcar el paso actual como fallido
        stepElements[currentStepIndex].classList.add('error');
        stepElements[currentStepIndex].classList.remove('active', 'pending', 'completed');

        // Mostrar el mensaje de error en el recuadro principal
        showMessage('error', errorMessage);

        // Avanzar al siguiente paso
        currentStepIndex++;
        if (currentStepIndex < stepElements.length) {
          // Marcar el siguiente paso como activo
          stepElements[currentStepIndex].classList.add('active');
          stepElements[currentStepIndex].classList.remove('completed', 'pending', 'error');
        }
      }
    }

    // Función para mostrar mensajes de éxito o error en el recuadro principal
    function showMessage(type, text) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = type === 'success' ? 'success' : 'error';
      messageDiv.innerText = text;
      messageDiv.style.display = 'block';
    }

    // Función para ocultar mensajes
    function hideMessage() {
      const messageDiv = document.getElementById('message');
      messageDiv.style.display = 'none';
    }

    // Función para mostrar el loader con mensaje y controlar la visibilidad de la lista de pasos
    function showLoader(message) {
      const loaderContainer = document.getElementById('loader-container');
      const loaderMessage = document.getElementById('loader-message');
      const stepsList = document.querySelector('.steps-list');

      loaderMessage.innerText = message;

      if (message === 'Submitting appraisal...') {
        stepsList.style.display = 'block';
      } else {
        stepsList.style.display = 'none';
      }

      loaderContainer.style.display = 'flex';
    }

    // Función para ocultar el loader y la lista de pasos
    function hideLoader() {
      const loaderContainer = document.getElementById('loader-container');
      const stepsList = document.querySelector('.steps-list');
      loaderContainer.style.display = 'none';
      stepsList.style.display = 'none';
    }

    // Función para cargar los detalles del appraisal
    function loadAppraisalDetails() {
      // Mostrar el loader con mensaje
      showLoader('Fetching appraisal details...');
      hideMessage();

      fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}/list`, {
        method: 'GET',
        credentials: 'include' // Incluir cookies en la solicitud
      })
      .then(res => {
        // Ocultar el loader después de recibir la respuesta
        hideLoader();

        if (res.status === 401 || res.status === 403) {
          throw new Error('You are not authenticated. Please log in.');
        } else if (res.status === 404) {
          throw new Error('Appraisal not found.');
        }
        return res.json();
      })
      .then(data => {
        // Verificar que los datos sean correctos
        if (!data || typeof data !== 'object') {
          throw new Error('Invalid appraisal data received.');
        }

        // Mostrar descripciones
        const customerDescriptionText = document.getElementById('customer-description-text');
        customerDescriptionText.innerText = data.customerDescription || 'Not available';

        const iaDescriptionText = document.getElementById('ia-description-text');
        iaDescriptionText.innerText = data.iaDescription || 'Not available';

        // Mostrar imágenes con etiquetas
        const imagesContainer = document.getElementById('images-container');
        imagesContainer.innerHTML = ''; // Limpiar imágenes existentes

        if (data.images) {
          // Main Image
          if (data.images.main) {
            const mainImageWrapper = document.createElement('div');
            mainImageWrapper.className = 'image-wrapper';

            const mainImage = document.createElement('img');
            mainImage.src = data.images.main;
            mainImage.alt = 'Main Image';
            mainImageWrapper.appendChild(mainImage);

            const mainLabel = document.createElement('div');
            mainLabel.className = 'image-label';
            mainLabel.innerText = 'Main Image';
            mainImageWrapper.appendChild(mainLabel);

            imagesContainer.appendChild(mainImageWrapper);
          }

          // Age Image
          if (data.images.age) {
            const ageImageWrapper = document.createElement('div');
            ageImageWrapper.className = 'image-wrapper';

            const ageImage = document.createElement('img');
            ageImage.src = data.images.age;
            ageImage.alt = 'Age Image';
            ageImageWrapper.appendChild(ageImage);

            const ageLabel = document.createElement('div');
            ageLabel.className = 'image-label';
            ageLabel.innerText = 'Age Image';
            ageImageWrapper.appendChild(ageLabel);

            imagesContainer.appendChild(ageImageWrapper);
          }

          // Signature Image
          if (data.images.signature) {
            const signatureImageWrapper = document.createElement('div');
            signatureImageWrapper.className = 'image-wrapper';

            const signatureImage = document.createElement('img');
            signatureImage.src = data.images.signature;
            signatureImage.alt = 'Signature Image';
            signatureImageWrapper.appendChild(signatureImage);

            const signatureLabel = document.createElement('div');
            signatureLabel.className = 'image-label';
            signatureLabel.innerText = 'Signature Image';
            signatureImageWrapper.appendChild(signatureLabel);

            imagesContainer.appendChild(signatureImageWrapper);
          }
        }

        showMessage('success', 'Appraisal details loaded successfully.');
      })
      .catch(err => {
        console.error('Error fetching appraisal details:', err);
        showMessage('error', err.message || 'Error fetching appraisal details.');
        hideLoader();

        // Redirigir a index si no está autenticado
        if (err.message.includes('not authenticated')) {
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
        }
      });
    }

    // Manejar el logout
    function logout() {
      // Mostrar el loader con mensaje
      showLoader('Logging out...');
      hideMessage();

      fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/logout', {
        method: 'POST',
        credentials: 'include' // Incluir cookies en la solicitud
      })
      .then(res => res.json())
      .then(data => {
        // Ocultar el loader después de recibir la respuesta
        hideLoader();

        if (data.success) {
          // Redirigir al dashboard
          window.location.href = 'index.html';
        } else {
          // Manejar fallo en el logout
          showMessage('error', 'Error logging out. Please try again.');
        }
      })
      .catch(err => {
        // Ocultar el loader en caso de error
        hideLoader();
        console.error('Error during logout:', err);
        showMessage('error', 'Error logging out. Please try again.');
      });
    }

    // Añadir event listener al botón de logout
    document.getElementById('logout-button').addEventListener('click', logout);

    // Función para manejar el envío del formulario y procesar los pasos
    document.getElementById('appraisal-form').addEventListener('submit', async function(event) {
      event.preventDefault();

      const appraisalValueInput = document.getElementById('appraisalValue');
      const appraisalValue = appraisalValueInput.value.trim();
      const appraiserDescription = document.getElementById('description').value.trim();
      const iaDescription = document.getElementById('ia-description-text').innerText.trim();

      // Validación del lado del cliente para el Appraisal Value
      if (appraisalValue === '') {
        showMessage('error', 'Missing Appraisal Value.');
        return;
      }

      // Opcional: Validar si appraisalValue es un número positivo
      if (isNaN(appraisalValue) || Number(appraisalValue) <= 0) {
        showMessage('error', 'Appraisal Value must be a positive number.');
        return;
      }

      // Mostrar el loader con el mensaje adecuado
      showLoader('Submitting appraisal...');
      showCurrentStepMessage();
      hideMessage();

      try {
      // Paso 1: Set Appraisal Value
const setValueResponse = await fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}/set-value`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  credentials: 'include',
  body: JSON.stringify({ 
    appraisalValue: appraisalValue,
    description: appraiserDescription
  })
});

const setValueData = await setValueResponse.json();

if (!setValueData.success) {
  throw new Error(setValueData.message || 'Error setting Appraisal Value.');
}

// Completar el Paso 1
completeCurrentStep();
showMessage('success', 'Appraisal Value y descripción establecidos correctamente.');


        // Paso 2: Merge Descriptions with OpenAI
        const mergeResponse = await fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}/merge-descriptions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ 
            appraiserDescription: appraiserDescription,
            iaDescription: iaDescription
          })
        });

        const mergeData = await mergeResponse.json();

        if (!mergeData.success) {
          throw new Error(mergeData.message || 'Error merging descriptions with OpenAI.');
        }

        completeCurrentStep();
        showMessage('success', 'Descriptions merged successfully.');

        // Paso 3: Update Post Title in WordPress
        const updateTitleResponse = await fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}/update-title`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ newTitle: mergeData.blendedDescription })
        });

        const updateTitleData = await updateTitleResponse.json();

        if (!updateTitleData.success) {
          throw new Error(updateTitleData.message || 'Error updating post title in WordPress.');
        }

        completeCurrentStep();
        showMessage('success', 'Post title updated successfully.');

        // Paso 4: Insert Shortcodes in WordPress Post
const insertShortcodesResponse = await fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}/insert-template`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  credentials: 'include',
  body: JSON.stringify({}) // Enviar un cuerpo vacío o puedes omitirlo completamente
});

const insertShortcodesData = await insertShortcodesResponse.json();

if (!insertShortcodesData.success) {
  throw new Error(insertShortcodesData.message || 'Error inserting shortcodes in WordPress.');
}

completeCurrentStep();
showMessage('success', 'Shortcodes inserted successfully in WordPress post.');


        // Paso 5: Building PDF
        async function buildPDF(appraisalData) {
          try {
            showLoader('Submitting appraisal...'); // Reutilizar el mensaje para mantener los pasos visibles
            completeCurrentStep();

            const { wordpressUrl } = appraisalData;

            if (!wordpressUrl) {
              throw new Error('WordPress URL is missing.');
            }

            // Extraer el postId de la URL de WordPress
            const parsedUrl = new URL(wordpressUrl);
            const postId = parsedUrl.searchParams.get('post');

            if (!postId) {
              throw new Error('Invalid WordPress URL: Post ID not found.');
            }

            // Paso 5.1: Obtener session_ID desde el backend
            const getSessionIdResponse = await fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/get-session-id', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                // Incluir cookies si es necesario para autenticación
              },
              body: JSON.stringify({ postId: postId })
            });

            const getSessionIdData = await getSessionIdResponse.json();

            if (!getSessionIdData.success) {
              throw new Error(getSessionIdData.message || 'Error fetching session_ID.');
            }

            const session_ID = getSessionIdData.session_ID;

            if (!session_ID) {
              throw new Error('session_ID not found.');
            }

            // Paso 5.2: Solicitar la generación del PDF con postId y session_ID
            const buildPdfResponse = await fetch('https://appraisals-backend-856401495068.us-central1.run.app/generate-pdf', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                // Incluir cookies si es necesario para autenticación
              },
              body: JSON.stringify({ postId: postId, session_ID: session_ID }) // Enviar ambos parámetros
            });

            const buildPdfData = await buildPdfResponse.json();

            if (!buildPdfData.success) {
              throw new Error(buildPdfData.message || 'Error building PDF.');
            }

            // Guardar los enlaces al PDF y al documento de Google Docs
            const pdfLink = buildPdfData.pdfLink;
            const docLink = buildPdfData.docLink;

            console.log(`PDF Link: ${pdfLink}`);
            console.log(`Document Link: ${docLink}`);

            // Opcional: Manejar el URL del PDF si es proporcionado
            if (buildPdfData.pdfUrl) {
              // Por ejemplo, redirigir al usuario para descargar el PDF
              window.open(buildPdfData.pdfUrl, '_blank');
            }

            // Aquí puedes guardar los enlaces en variables si es necesario
            // Por ejemplo:
            // window.pdfLink = pdfLink;
            // window.docLink = docLink;

            completeCurrentStep();
            showMessage('success', 'PDF built successfully.');
          } catch (error) {
            hideLoader();
            showMessage('error', error.message);
            console.error('Error en la generación de PDF:', error);
            failCurrentStep(error.message || 'Error building PDF.');
          }
        }

        // Llamar a la función para construir el PDF
        await buildPDF(data);

        // Paso 6: Send Email to Customer
        await sendEmailToCustomer(appraisalId);

        // Paso 7: Mark Appraisal as Completed
        const completeAppraisalResponse = await fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}/complete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ appraisalValue, description: appraiserDescription })
        });

        const completeAppraisalData = await completeAppraisalResponse.json();

        if (!completeAppraisalData.success) {
          throw new Error(completeAppraisalData.message || 'Error marking appraisal as completed.');
        }

        completeCurrentStep();
        showMessage('success', 'Appraisal marked as completed successfully.');

        // Redirigir al dashboard después de completar todos los pasos
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 9000);

      } catch (error) {
        console.error('Error during appraisal process:', error);
        hideLoader();

        // Marcar el paso actual como fallido y mostrar el mensaje de error
        failCurrentStep(error.message || 'An unexpected error occurred during the appraisal process.');
      }
    });

    // Función para guardar los enlaces al PDF y al documento de Google Docs
    async function handleBuildPdf(appraisalId) {
      try {
        // Obtener los detalles de la apreciación
        const appraisalResponse = await fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
            // Incluir cookies si es necesario para autenticación
          }
        });

        const appraisalData = await appraisalResponse.json();

        if (!appraisalData || !appraisalData.id) {
          throw new Error('Appraisal data not found.');
        }

        // Llamar a la función para construir el PDF
        await buildPDF(appraisalData);
      } catch (error) {
        hideLoader();
        showMessage('error', error.message);
        console.error('Error al manejar la generación de PDF:', error);
      }
    }

    // Paso 6: Send Email to Customer
    async function sendEmailToCustomer(appraisalId) {
      try {
        showLoader('Submitting appraisal...'); // Reutilizar el mensaje para mantener los pasos visibles
        hideMessage();

        const sendEmailResponse = await fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}/send-email`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include' // Asegúrate de que las cookies se envían correctamente
          // No es necesario enviar body ya que el 'id' está en la URL
        });

        const sendEmailData = await sendEmailResponse.json();
        console.log('Datos de respuesta del envío de email:', sendEmailData);

        if (!sendEmailData.success) {
          throw new Error(sendEmailData.message || 'Error sending email to customer.');
        }

        completeCurrentStep();
        hideLoader();
        showMessage('success', 'Email sent to customer successfully.');
      } catch (error) {
        hideLoader();
        showMessage('error', error.message);
        console.error('Error sending email to customer:', error);
        failCurrentStep(error.message || 'Error sending email to customer.');
      }
    }

    // Función para marcar el paso actual como fallido y avanzar al siguiente
    function failCurrentStep(errorMessage) {
      if (currentStepIndex < stepElements.length) {
        console.error(`Failing step ${currentStepIndex + 1}: ${steps[currentStepIndex]} - Error: ${errorMessage}`);
        // Marcar el paso actual como fallido
        stepElements[currentStepIndex].classList.add('error');
        stepElements[currentStepIndex].classList.remove('active', 'pending', 'completed');

        // Mostrar el mensaje de error en el recuadro principal
        showMessage('error', errorMessage);

        // Avanzar al siguiente paso
        currentStepIndex++;
        if (currentStepIndex < stepElements.length) {
          // Marcar el siguiente paso como activo
          stepElements[currentStepIndex].classList.add('active');
          stepElements[currentStepIndex].classList.remove('completed', 'pending', 'error');
        }
      }
    }

    // Función para cargar los detalles del appraisal y mostrar el botón de logout si está autenticado
    window.onload = () => {
      loadAppraisalDetails();
      // Mostrar el botón de logout
      document.getElementById('logout-button').style.display = 'block';
      // Inicializar los mensajes de pasos
      showCurrentStepMessage();
    };
  </script>

</body>
</html>
