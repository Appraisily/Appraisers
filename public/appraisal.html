<!-- public/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Appraisers Dashboard</title>
  <!-- Load Google Identity Services library -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Link to the external CSS file -->
  <link rel="stylesheet" href="/css/styles.css">
  
  <style>
    /* Estilos para el contenedor de búsqueda y selector */
    .controls-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .search-container {
      display: flex;
      justify-content: flex-end;
      flex-grow: 1;
    }

    .search-container input[type="text"] {
      padding: 5px;
      font-size: 14px;
      width: 200px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .toggle-container {
      display: flex;
      align-items: center;
    }

    .toggle-container label {
      margin-right: 10px;
      font-weight: bold;
    }

    .toggle-container select {
      padding: 5px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* Estilos para la tabla */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th, table td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }

    table th {
      background-color: #f2f2f2;
    }

    /* Estilos para mensajes */
    .success {
      color: green;
    }

    .error {
      color: red;
    }

    /* Estilos para el loader */
    #loader {
      display: none;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 2s linear infinite;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Estilos para el footer */
    .footer {
      text-align: center;
      margin-top: 20px;
      color: #888;
    }

    /* Estilos para la visualización del nombre de usuario */
    .user-name {
      margin-bottom: 10px;
      font-weight: bold;
    }
  </style>
  
</head>
<body>
  <!-- Logout Button -->
  <button id="logout-button" class="logout-button" style="display: none;">Logout</button>

  <!-- Div to display the user's name -->
  <div id="user-name" class="user-name" style="display: none;"></div>
  
  <div class="container">
    <!-- Logo -->
    <div class="logo">
      <a href="https://www.appraisily.com/" target="_blank">
        <img src="https://www.appraisily.com/wp-content/uploads/2023/12/cropped-appraisily.com_a_logo_for_an_online_art_and_antiques_appraisal__a8888b1f-2dbb-479e-9833-09c6263f0892.webp" alt="Appraisily Logo">
      </a>
    </div>

    <!-- Title -->
    <div class="title">Welcome to the Appraisers Dashboard</div>

    <!-- Success/Error Messages -->
    <div id="message"></div>

    <!-- Google Sign-In Button -->
    <div class="signin-container">
      <div id="g_id_onload"
           data-client_id="856401495068-ica4bncmu5t8i0muugrn9t8t25nt1hb4.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>
      <div id="g_id_signin" class="g_id_signin"
           data-type="standard"
           data-shape="rectangular"
           data-theme="outline"
           data-text="sign_in_with"
           data-size="large"
           data-logo_alignment="left">
      </div>
    </div>

    <!-- Loader -->
    <div id="loader"></div>

    <!-- Appraisals Container -->
    <div id="appraisals"></div>
  </div>

  <!-- Footer -->
  <div class="footer">
    © <span id="current-year"></span> Appraisily. All rights reserved.
  </div>

<script>
  // Actualizar el año en el footer
  document.getElementById('current-year').textContent = new Date().getFullYear();

  // Obtener el ID del appraisal de los parámetros de la URL
  const urlParams = new URLSearchParams(window.location.search);
  const appraisalId = urlParams.get('id');

  if (!appraisalId) {
    alert('Appraisal ID no proporcionado.');
    window.location.href = 'index.html';
  }

  // Definir los pasos
  const steps = ['step-1', 'step-2', 'step-3', 'step-4', 'step-5', 'step-6', 'step-7'];
  let currentStepIndex = 0; // Índice del paso actual (0-based)

  // Obtener referencias a los mensajes y puntos
  const stepMessages = steps.map(step => document.getElementById(`message-${step}`));
  const progressDots = steps.map(step => document.getElementById(`dot-${step.split('-')[1]}`));

  // Inicializar descripciones para los tooltips de los dots
  const stepDescriptions = [
    "Set Appraisal Value",
    "Merge Descriptions with OpenAI",
    "Update Post Title in WordPress",
    "Insert WordPress Template",
    "Building PDF",
    "Send Email to Customer",
    "Mark Appraisal as Completed"
  ];

  // Asignar descripciones a los dots para los tooltips
  progressDots.forEach((dot, index) => {
    if (dot) {
      dot.setAttribute('data-description', stepDescriptions[index]);
    } else {
      console.warn(`Dot with ID 'dot-${index + 1}' not found.`);
    }
  });

  // Función para mostrar el mensaje del paso actual
  function showCurrentStepMessage() {
    stepMessages.forEach((message, index) => {
      if (index === currentStepIndex) {
        message.classList.add('active');
      } else {
        message.classList.remove('active');
      }
    });
  }

  // Función para completar el paso actual y avanzar al siguiente
  function completeCurrentStep() {
    if (currentStepIndex < steps.length) {
      console.log(`Completing step ${currentStepIndex + 1}: ${steps[currentStepIndex]}`);
      // Marcar el mensaje actual como completado (animación hacia arriba)
      stepMessages[currentStepIndex].classList.remove('active');
      stepMessages[currentStepIndex].classList.add('completed');

      // Actualizar el dot correspondiente
      progressDots[currentStepIndex].classList.remove('active');
      progressDots[currentStepIndex].classList.add('completed');

      // Avanzar al siguiente paso
      currentStepIndex++;
      if (currentStepIndex < steps.length) {
        // Mostrar el siguiente mensaje
        stepMessages[currentStepIndex].classList.add('active');

        // Actualizar el dot siguiente a activo
        progressDots[currentStepIndex].classList.add('active');
      }
    }
  }

  // Función para marcar el paso actual como fallido y avanzar al siguiente
  function failCurrentStep(errorMessage) {
    if (currentStepIndex < steps.length) {
      console.error(`Failing step ${currentStepIndex + 1}: ${steps[currentStepIndex]} - Error: ${errorMessage}`);
      // Marcar el mensaje actual como fallido
      stepMessages[currentStepIndex].classList.remove('active');
      stepMessages[currentStepIndex].classList.add('failed');

      // Actualizar el dot correspondiente
      progressDots[currentStepIndex].classList.remove('active');
      progressDots[currentStepIndex].classList.add('failed');

      // Mostrar el mensaje de error en el rectángulo
      showMessage('error', errorMessage);

      // Avanzar al siguiente paso
      currentStepIndex++;
      if (currentStepIndex < steps.length) {
        // Mostrar el siguiente mensaje
        stepMessages[currentStepIndex].classList.add('active');

        // Actualizar el dot siguiente a activo
        progressDots[currentStepIndex].classList.add('active');
      }
    }
  }

  // Función para mostrar mensajes de éxito o error en el recuadro principal
  function showMessage(type, text) {
    const messageDiv = document.getElementById('message');
    messageDiv.className = type === 'success' ? 'success' : 'error';
    messageDiv.innerText = text;
    messageDiv.style.display = 'block';
  }

  // Función para ocultar mensajes
  function hideMessage() {
    const messageDiv = document.getElementById('message');
    messageDiv.style.display = 'none';
  }

  // Función para mostrar el loader con mensaje
  function showLoader(message) {
    const loaderContainer = document.getElementById('loader-container');
    const loaderMessage = document.getElementById('loader-message');
    loaderMessage.innerText = message;
    loaderContainer.style.display = 'flex';
  }

  // Función para ocultar el loader
  function hideLoader() {
    const loaderContainer = document.getElementById('loader-container');
    loaderContainer.style.display = 'none';
  }

  // Función para cargar los detalles del appraisal
  function loadAppraisalDetails() {
    // Mostrar el loader con mensaje
    showLoader('Fetching appraisal details...');
    hideMessage();

    fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}`, {
      method: 'GET',
      credentials: 'include' // Incluir cookies en la solicitud
    })
    .then(res => {
      // Ocultar el loader después de recibir la respuesta
      hideLoader();

      if (res.status === 401 || res.status === 403) {
        throw new Error('You are not authenticated. Please log in.');
      } else if (res.status === 404) {
        throw new Error('Appraisal not found.');
      }
      return res.json();
    })
    .then(data => {
      // Mostrar descripciones
      const customerDescriptionText = document.getElementById('customer-description-text');
      customerDescriptionText.innerText = data.customerDescription || 'Not available';

      const iaDescriptionText = document.getElementById('ia-description-text');
      iaDescriptionText.innerText = data.iaDescription || 'Not available';

      // Mostrar imágenes con etiquetas
      const imagesContainer = document.getElementById('images-container');
      imagesContainer.innerHTML = ''; // Limpiar imágenes existentes

      if (data.images) {
        // Main Image
        if (data.images.main) {
          const mainImageWrapper = document.createElement('div');
          mainImageWrapper.className = 'image-wrapper';

          const mainImage = document.createElement('img');
          mainImage.src = data.images.main;
          mainImage.alt = 'Main Image';
          mainImageWrapper.appendChild(mainImage);

          const mainLabel = document.createElement('div');
          mainLabel.className = 'image-label';
          mainLabel.innerText = 'Main Image';
          mainImageWrapper.appendChild(mainLabel);

          imagesContainer.appendChild(mainImageWrapper);
        }

        // Age Image
        if (data.images.age) {
          const ageImageWrapper = document.createElement('div');
          ageImageWrapper.className = 'image-wrapper';

          const ageImage = document.createElement('img');
          ageImage.src = data.images.age;
          ageImage.alt = 'Age Image';
          ageImageWrapper.appendChild(ageImage);

          const ageLabel = document.createElement('div');
          ageLabel.className = 'image-label';
          ageLabel.innerText = 'Age Image';
          ageImageWrapper.appendChild(ageLabel);

          imagesContainer.appendChild(ageImageWrapper);
        }

        // Signature Image
        if (data.images.signature) {
          const signatureImageWrapper = document.createElement('div');
          signatureImageWrapper.className = 'image-wrapper';

          const signatureImage = document.createElement('img');
          signatureImage.src = data.images.signature;
          signatureImage.alt = 'Signature Image';
          signatureImageWrapper.appendChild(signatureImage);

          const signatureLabel = document.createElement('div');
          signatureLabel.className = 'image-label';
          signatureLabel.innerText = 'Signature Image';
          signatureImageWrapper.appendChild(signatureLabel);

          imagesContainer.appendChild(signatureImageWrapper);
        }
      }

      showMessage('success', 'Appraisal details loaded successfully.');
    })
    .catch(err => {
      console.error('Error fetching appraisal details:', err);
      showMessage('error', err.message || 'Error fetching appraisal details.');
      hideLoader();

      // Redirigir a index si no está autenticado
      if (err.message.includes('not authenticated')) {
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
      }
    });
  }

  // Manejar el logout
  function logout() {
    // Mostrar el loader con mensaje
    showLoader('Logging out...');
    hideMessage();

    fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/logout', {
      method: 'POST',
      credentials: 'include' // Incluir cookies en la solicitud
    })
    .then(res => res.json())
    .then(data => {
      // Ocultar el loader después de recibir la respuesta
      hideLoader();

      if (data.success) {
        // Redirigir al dashboard
        window.location.href = 'index.html';
      } else {
        // Manejar fallo en el logout
        showMessage('error', 'Error logging out. Please try again.');
      }
    })
    .catch(err => {
      // Ocultar el loader en caso de error
      hideLoader();
      console.error('Error during logout:', err);
      showMessage('error', 'Error logging out. Please try again.');
    });
  }

  // Añadir event listener al botón de logout
  document.getElementById('logout-button').addEventListener('click', logout);

  // Función para actualizar el mensaje del paso actual al cargar la página
  function initializeStepMessages() {
    stepMessages.forEach((message, index) => {
      if (index < currentStepIndex) {
        // Pasos ya completados
        message.classList.add('completed');
        progressDots[index].classList.add('completed');
      } else if (index === currentStepIndex) {
        // Paso actual
        message.classList.add('active');
        progressDots[index].classList.add('active');
      }
      // Los pasos restantes no tienen clases adicionales
    });
  }

  // Definir funciones auxiliares fuera del manejador de eventos
  async function buildPDF(appraisalData) {
    try {
      showLoader('Building PDF...');

      const { wordpressUrl } = appraisalData;

      if (!wordpressUrl) {
        throw new Error('WordPress URL is missing.');
      }

      // Extraer el postId de la URL de WordPress
      const parsedUrl = new URL(wordpressUrl);
      const postId = parsedUrl.searchParams.get('post');

      if (!postId) {
        throw new Error('Invalid WordPress URL: Post ID not found.');
      }

      // Paso 5.1: Obtener session_ID desde el backend
      const getSessionIdResponse = await fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/get-session-id', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
          // Incluir cookies si es necesario para autenticación
        },
        body: JSON.stringify({ postId: postId })
      });

      const getSessionIdData = await getSessionIdResponse.json();

      if (!getSessionIdData.success) {
        throw new Error(getSessionIdData.message || 'Error fetching session_ID.');
      }

      const session_ID = getSessionIdData.session_ID;

      if (!session_ID) {
        throw new Error('session_ID not found.');
      }

      // Paso 5.2: Solicitar la generación del PDF con postId y session_ID
      const buildPdfResponse = await fetch('https://appraisers-backend-856401495068.us-central1.run.app/generate-pdf', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
          // Incluir cookies si es necesario para autenticación
        },
        body: JSON.stringify({ postId: postId, session_ID: session_ID }) // Enviar ambos parámetros
      });

      console.log(`[buildPDF] Respuesta recibida del backend: ${buildPdfResponse.status}`);

      const buildPdfData = await buildPdfResponse.json();
      console.log('[buildPDF] Datos de respuesta:', buildPdfData);

      if (!buildPdfData.success) {
        console.warn(`[buildPDF] Falló la generación del PDF: ${buildPdfData.message}`);
        throw new Error(buildPdfData.message || 'Error building PDF.');
      }

      // **Guardar los enlaces en variables**
      const pdfLink = buildPdfData.pdfLink;
      const docLink = buildPdfData.docLink;

      console.log(`[buildPDF] PDF Link: ${pdfLink}`);
      console.log(`[buildPDF] Document Link: ${docLink}`);

      // **Opcional: Manejar el URL del PDF si es proporcionado**
      if (buildPdfData.pdfUrl) {
        console.log('[buildPDF] Abriendo el PDF en una nueva pestaña.');
        window.open(buildPdfData.pdfUrl, '_blank');
      }

      // **Almacenar los enlaces en variables globales o en el estado (si usas React, por ejemplo)**
      // Por ahora, simplemente los almacenaremos en variables locales
      // Si necesitas usarlos en otras partes de tu aplicación, considera almacenarlos en el estado o en un contexto

      // Ejemplo de almacenamiento en variables locales
      const storedPdfLink = pdfLink;
      const storedDocLink = docLink;

      console.log(`[buildPDF] Enlaces almacenados - PDF: ${storedPdfLink}, Documento: ${storedDocLink}`);

      completeCurrentStep();
      hideLoader();
      showMessage('success', 'PDF built successfully.');
    } catch (error) {
      hideLoader();
      showMessage('error', error.message);
      console.error('Error en la generación de PDF:', error);
    }
  }

  async function sendEmailToCustomer(appraisalId) {
    try {
      showLoader('Sending email to customer...');

      const sendEmailResponse = await fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}/send-email`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include' // Asegúrate de que las cookies se envían correctamente
        // No es necesario enviar body ya que el 'id' está en la URL
      });

      console.log(`[sendEmailToCustomer] Respuesta del servidor: ${sendEmailResponse.status}`);

      const sendEmailData = await sendEmailResponse.json();
      console.log(`[sendEmailToCustomer] Datos recibidos:`, sendEmailData);

      if (!sendEmailData.success) {
        throw new Error(sendEmailData.message || 'Error sending email to customer.');
      }

      completeCurrentStep();
      hideLoader();
      showMessage('success', 'Email sent to customer successfully.');
    } catch (error) {
      hideLoader();
      showMessage('error', error.message);
      console.error('[sendEmailToCustomer] Error enviando email al cliente:', error);
    }
  }

  // Manejar el envío del formulario y procesar los pasos
  document.getElementById('appraisal-form').addEventListener('submit', async function(event) {
    event.preventDefault();

    const appraisalValueInput = document.getElementById('appraisalValue');
    const appraisalValue = appraisalValueInput.value.trim();
    const appraiserDescription = document.getElementById('description').value.trim();
    const iaDescription = document.getElementById('ia-description-text').innerText.trim();

    // Validación del lado del cliente para el Appraisal Value
    if (appraisalValue === '') {
      showMessage('error', 'Missing Appraisal Value.');
      return;
    }

    // Opcional: Validar si appraisalValue es un número positivo
    if (isNaN(appraisalValue) || Number(appraisalValue) <= 0) {
      showMessage('error', 'Appraisal Value must be a positive number.');
      return;
    }

    // Mostrar el loader con el mensaje adecuado
    showLoader('Submitting appraisal...');
    hideMessage();

    try {
      // Paso 1: Set Appraisal Value (ya implementado en backend)
      completeCurrentStep();

      // Paso 2: Merge Descriptions with OpenAI
      const mergeResponse = await fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}/merge-descriptions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({ 
          appraiserDescription: appraiserDescription,
          iaDescription: iaDescription
        })
      });

      const mergeData = await mergeResponse.json();

      if (!mergeData.success) {
        throw new Error(mergeData.message || 'Error merging descriptions with OpenAI.');
      }

      completeCurrentStep();
      hideLoader();
      showMessage('success', 'Descriptions merged successfully.');

      // Paso 3: Update Post Title in WordPress
      const updateTitleResponse = await fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}/update-title`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({ newTitle: mergeData.blendedDescription })
      });

      const updateTitleData = await updateTitleResponse.json();

      if (!updateTitleData.success) {
        throw new Error(updateTitleData.message || 'Error updating post title in WordPress.');
      }

      completeCurrentStep();
      hideLoader();
      showMessage('success', 'Post title updated successfully.');

      // Paso 4: Insert Shortcodes in WordPress Post
      const insertShortcodesResponse = await fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}/insert-template`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({}) // Enviar un cuerpo vacío o puedes omitirlo completamente
      });

      const insertShortcodesData = await insertShortcodesResponse.json();

      if (!insertShortcodesData.success) {
        throw new Error(insertShortcodesData.message || 'Error inserting shortcodes in WordPress.');
      }

      completeCurrentStep();
      hideLoader();
      showMessage('success', 'Shortcodes inserted successfully in WordPress post.');

      // Paso 5: Building PDF
      // Primero, debes obtener los detalles del appraisal para pasar los datos necesarios
      const appraisalDetailsResponse = await fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}`, {
        method: 'GET',
        credentials: 'include'
      });

      const appraisalDetails = await appraisalDetailsResponse.json();

      if (!appraisalDetails.success) {
        throw new Error('Error fetching appraisal details for PDF.');
      }

      await buildPDF(appraisalDetails); // Llamar a la función buildPDF

      // Paso 6: Send Email to Customer
      await sendEmailToCustomer(appraisalId); // Llamar a la función sendEmailToCustomer

      // Paso 7: Mark Appraisal as Completed
      const completeAppraisalResponse = await fetch(`https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals/${appraisalId}/complete`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({ appraisalValue, description: appraiserDescription })
      });

      const completeAppraisalData = await completeAppraisalResponse.json();

      if (!completeAppraisalData.success) {
        throw new Error(completeAppraisalData.message || 'Error marking appraisal as completed.');
      }

      completeCurrentStep();
      hideLoader();
      showMessage('success', 'Appraisal marked as completed successfully.');

      // Redirigir al dashboard después de completar todos los pasos
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 9000);

    } catch (error) {
      console.error('Error during appraisal process:', error);
      hideLoader();

      // Marcar el paso actual como fallido y mostrar el mensaje de error
      failCurrentStep(error.message || 'An unexpected error occurred during the appraisal process.');
    }
  });

  // Función para cargar los detalles del appraisal y mostrar el botón de logout si está autenticado
  window.onload = () => {
    loadAppraisalDetails();
    // Mostrar el botón de logout
    document.getElementById('logout-button').style.display = 'block';
    // Inicializar los mensajes de pasos
    initializeStepMessages();
  };
</script>

</body>
</html>
