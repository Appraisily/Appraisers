<!-- public/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Appraisers Dashboard</title>
  <!-- Load Google Identity Services library -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Link to the external CSS file -->
  <link rel="stylesheet" href="/css/styles.css">
  
  <style>
    /* Estilos para el contenedor de búsqueda */
    .search-container {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
    }

    .search-container input[type="text"] {
      padding: 5px;
      font-size: 14px;
      width: 200px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .search-container button {
      padding: 5px 10px;
      margin-left: 5px;
      font-size: 14px;
      border: none;
      background-color: #4CAF50;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    .search-container button:hover {
      background-color: #45a049;
    }

    /* Estilos para la tabla */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th, table td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }

    table th {
      background-color: #f2f2f2;
    }

    /* Estilos para mensajes */
    .success {
      color: green;
    }

    .error {
      color: red;
    }

    /* Estilos para el loader */
    #loader {
      display: none;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 2s linear infinite;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Estilos para el footer */
    .footer {
      text-align: center;
      margin-top: 20px;
      color: #888;
    }
  </style>
  
</head>
<body>
  <!-- Logout Button -->
  <button id="logout-button" class="logout-button" style="display: none;">Logout</button>

  <!-- Div to display the user's name -->
  <div id="user-name" class="user-name" style="display: none;"></div>
  
  <div class="container">
    <!-- Logo -->
    <div class="logo">
      <a href="https://www.appraisily.com/" target="_blank">
        <img src="https://www.appraisily.com/wp-content/uploads/2023/12/cropped-appraisily.com_a_logo_for_an_online_art_and_antiques_appraisal__a8888b1f-2dbb-479e-9833-09c6263f0892.webp" alt="Appraisily Logo">
      </a>
    </div>

    <!-- Title -->
    <div class="title">Welcome to the Appraisers Dashboard</div>

    <!-- Success/Error Messages -->
    <div id="message"></div>

    <!-- Google Sign-In Button -->
    <div class="signin-container">
      <div id="g_id_onload"
           data-client_id="856401495068-ica4bncmu5t8i0muugrn9t8t25nt1hb4.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>
      <div id="g_id_signin" class="g_id_signin"
           data-type="standard"
           data-shape="rectangular"
           data-theme="outline"
           data-text="sign_in_with"
           data-size="large"
           data-logo_alignment="left">
      </div>
    </div>

    <!-- Loader -->
    <div id="loader"></div>

    <!-- Appraisals Container -->
    <div id="appraisals"></div>
  </div>

  <!-- Footer -->
  <div class="footer">
    © <span id="current-year"></span> Appraisily. All rights reserved.
  </div>

  <script>
    // Update the year in the footer
    document.getElementById('current-year').textContent = new Date().getFullYear();

    // Function to show messages
    function showMessage(type, text) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = type === 'success' ? 'success' : 'error';
      messageDiv.innerText = text;
      messageDiv.style.display = 'block';
    }

    // Function to hide messages
    function hideMessage() {
      const messageDiv = document.getElementById('message');
      messageDiv.style.display = 'none';
    }

    // Handle Google Sign-In credential response
    function handleCredentialResponse(response) {
      const idToken = response.credential;
      console.log("ID Token:", idToken);
      
      // Show the loader during authentication
      document.getElementById('loader').style.display = 'block';
      hideMessage();
      
      // Send the ID token to the backend for verification and JWT issuance
      fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/authenticate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ idToken }),
        credentials: 'include' // Include cookies in the request
      })
      .then(res => res.json())
      .then(data => {
        // Hide the loader after receiving the response
        document.getElementById('loader').style.display = 'none';
        
        if (data.success) {
          // Store the user's name
          const userName = data.name;
          localStorage.setItem('userName', data.name);

          // Show the logout button and hide the sign-in button
          document.getElementById('logout-button').style.display = 'block';
          document.getElementById('g_id_signin').style.display = 'none';

          // Show the user name
          showUserName(userName);

          // Show a success message
          showMessage('success', 'Authentication successful. Loading appraisals...');
          // Load the appraisals
          loadAppraisals();
        } else {
          // Handle authentication failure
          showMessage('error', data.message || 'Authentication failed. Please try again.');
        }
      })
      .catch(err => {
        // Hide the loader in case of error
        document.getElementById('loader').style.display = 'none';
        console.error('Error during authentication:', err);
        showMessage('error', 'Error during authentication. Please try again.');
      });
    }

    // Function to show the user's name
    function showUserName(name) {
      const userNameDiv = document.getElementById('user-name');
      userNameDiv.textContent = `Logged in as ${name}`;
      userNameDiv.style.display = 'block';
    }

    // Variable to store all appraisals data
    let allAppraisals = [];

    // Function to load appraisals from the backend
    function loadAppraisals() {
      // Show the loader while fetching appraisals
      document.getElementById('loader').style.display = 'block';
      hideMessage();

      fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include' // Include cookies in the request
      })
      .then(res => {
        // Hide the loader after receiving the response
        document.getElementById('loader').style.display = 'none';
        
        if (res.status === 401 || res.status === 403) {
          throw new Error('Unauthorized. Please log in again.');
        }
        return res.json();
      })
      .then(data => {
        allAppraisals = data; // Store all appraisals data

        // Render the search box and the table
        renderAppraisalsTable(allAppraisals);

        showMessage('success', 'Appraisals loaded successfully.');
      })
      .catch(err => {
        // Hide the loader in case of error
        document.getElementById('loader').style.display = 'none';
        console.error('Error fetching appraisals:', err);
        showMessage('error', err.message || 'Error fetching appraisals.');

        // Show the sign-in button and hide the logout button
        document.getElementById('logout-button').style.display = 'none';
        document.getElementById('g_id_signin').style.display = 'block';

        // Clear the appraisals
        document.getElementById('appraisals').innerHTML = '';
      });
    }

    // Función para renderizar el cuadro de búsqueda y la tabla de apreciaciones
    function renderAppraisalsTable(appraisals) {
      const appraisalsDiv = document.getElementById('appraisals');

      // Limpiar contenido previo
      appraisalsDiv.innerHTML = '';

      // Crear el contenedor de búsqueda
      const searchContainer = document.createElement('div');
      searchContainer.className = 'search-container';

      // Crear el input de búsqueda
      const searchInput = document.createElement('input');
      searchInput.type = 'text';
      searchInput.id = 'search-input';
      searchInput.placeholder = 'Search...';

      // Crear el botón de búsqueda
      const searchButton = document.createElement('button');
      searchButton.id = 'search-button';
      searchButton.textContent = 'Search';

      // Añadir el input y el botón al contenedor de búsqueda
      searchContainer.appendChild(searchInput);
      searchContainer.appendChild(searchButton);

      // Añadir el contenedor de búsqueda al div de apreciaciones
      appraisalsDiv.appendChild(searchContainer);

      // Crear la tabla
      let tableHTML = `
        <table id="appraisals-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Appraisal Type</th>
              <th>Appraisal Number</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
      `;

      if (appraisals.length === 0) {
        tableHTML += `
          <tr>
            <td colspan="5">No pending appraisals.</td>
          </tr>
        `;
      } else {
        appraisals.forEach(appraisal => {
          tableHTML += `
            <tr>
              <td data-label="Date">${appraisal.date}</td>
              <td data-label="Appraisal Type">${appraisal.appraisalType}</td>
              <td data-label="Appraisal Number" title="${appraisal.identifier}">
                ${appraisal.identifier}
              </td>
              <td data-label="Status">${appraisal.status}</td>
              <td data-label="Action">
                <button class="action-button" data-id="${appraisal.id}" data-url="${appraisal.wordpressUrl}">Complete</button>
              </td>
            </tr>
          `;
        });
      }

      tableHTML += `
          </tbody>
        </table>
      `;

      // Añadir la tabla al div de apreciaciones
      appraisalsDiv.innerHTML += tableHTML;

      // Añadir event listeners a los botones "Complete"
      document.querySelectorAll('.action-button').forEach(button => {
        button.addEventListener('click', () => {
          const appraisalId = button.getAttribute('data-id');
          const wordpressUrl = button.getAttribute('data-url');
          // Redireccionar a la página de completado de apreciación con parámetros
          window.location.href = `appraisal.html?id=${appraisalId}&wpUrl=${encodeURIComponent(wordpressUrl)}`;
        });
      });

      // Añadir event listener al botón de búsqueda
      document.getElementById('search-button').addEventListener('click', () => {
        const query = document.getElementById('search-input').value.trim().toLowerCase();
        filterAppraisalsTable(query);
      });
    }

    // Función para filtrar la tabla de apreciaciones según la consulta de búsqueda
    function filterAppraisalsTable(query) {
      const filteredAppraisals = allAppraisals.filter(appraisal => {
        // Verificar si alguno de los campos contiene la consulta
        return (
          (appraisal.date && appraisal.date.toLowerCase().includes(query)) ||
          (appraisal.appraisalType && appraisal.appraisalType.toLowerCase().includes(query)) ||
          (appraisal.identifier && appraisal.identifier.toLowerCase().includes(query)) ||
          (appraisal.status && appraisal.status.toLowerCase().includes(query))
        );
      });

      // Renderizar nuevamente la tabla con las apreciaciones filtradas
      renderAppraisalsTable(filteredAppraisals);

      if (filteredAppraisals.length === 0) {
        showMessage('error', 'No appraisals match your search.');
      } else {
        showMessage('success', `${filteredAppraisals.length} appraisal(s) found.`);
      }
    }

    // Función para manejar el cierre de sesión
    function logout() {
      // Mostrar el loader mientras se cierra sesión
      document.getElementById('loader').style.display = 'block';
      hideMessage();

      fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/logout', {
        method: 'POST',
        credentials: 'include' // Incluir cookies en la solicitud
      })
      .then(res => res.json())
      .then(data => {
        // Ocultar el loader después de recibir la respuesta
        document.getElementById('loader').style.display = 'none';
        
        if (data.success) {
          // Mostrar el botón de inicio de sesión y ocultar el de cierre de sesión
          document.getElementById('g_id_signin').style.display = 'block';
          document.getElementById('logout-button').style.display = 'none';
          
          // Eliminar el nombre del usuario del localStorage
          localStorage.removeItem('userName');
          
          // Ocultar la visualización del nombre del usuario
          document.getElementById('user-name').style.display = 'none';

          // Limpiar las apreciaciones
          document.getElementById('appraisals').innerHTML = '';
          // Mostrar un mensaje de éxito
          showMessage('success', 'Successfully logged out.');
        } else {
          // Manejar el fallo en el cierre de sesión
          showMessage('error', 'Error logging out. Please try again.');
        }
      })
      .catch(err => {
        // Ocultar el loader en caso de error
        document.getElementById('loader').style.display = 'none';
        console.error('Error during logout:', err);
        showMessage('error', 'Error logging out. Please try again.');
      });
    }

    // Añadir event listener al botón de cierre de sesión
    document.getElementById('logout-button').addEventListener('click', logout);

    // Verificar el estado de autenticación al cargar la página
    window.onload = () => {
      // Verificar si el nombre del usuario está en el localStorage
      const userName = localStorage.getItem('userName');
      
      if (userName) {
        // Mostrar el botón de cierre de sesión y ocultar el de inicio de sesión
        document.getElementById('logout-button').style.display = 'block';
        document.getElementById('g_id_signin').style.display = 'none';

        // Mostrar la visualización del nombre del usuario
        showUserName(userName);

        // Cargar las apreciaciones
        loadAppraisals();
      } else {
        // Usuario no autenticado
        document.getElementById('logout-button').style.display = 'none';
        document.getElementById('g_id_signin').style.display = 'block';
      }
    };
  </script>
</body>
</html>
