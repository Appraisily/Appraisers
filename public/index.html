<!-- public/index.html -->

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Appraisers Frontend</title>
    <!-- Cargar la biblioteca de Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      /* Estilos básicos para centrar el contenido */
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f9f9f9;
      }
      h1 {
        margin-bottom: 20px;
      }
      #appraisals {
        margin-top: 20px;
        width: 90%;
        max-width: 1000px;
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background-color: #fff;
      }
      th, td {
        padding: 12px 15px;
        border: 1px solid #ddd;
        text-align: left;
      }
      th {
        background-color: #f4f4f4;
      }
      tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      #logout-button {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #d9534f;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #logout-button:hover {
        background-color: #c9302c;
      }
      /* Loader Styles */
      #loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin-top: 20px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Mensajes de Error/Información */
      #message {
        margin-top: 20px;
        padding: 10px 20px;
        border-radius: 4px;
        display: none;
      }
      #message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      #message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      /* Responsive Table */
      @media screen and (max-width: 600px) {
        table, thead, tbody, th, td, tr {
          display: block;
        }
        th {
          position: absolute;
          top: -9999px;
          left: -9999px;
        }
        tr {
          margin-bottom: 1rem;
        }
        td {
          border: none;
          position: relative;
          padding-left: 50%;
        }
        td:before {
          position: absolute;
          top: 12px;
          left: 12px;
          width: 45%;
          padding-right: 10px;
          white-space: nowrap;
          font-weight: bold;
        }
        /* Label each cell with the corresponding header */
        td:nth-of-type(1):before { content: "ID"; }
        td:nth-of-type(2):before { content: "Fecha"; }
        td:nth-of-type(3):before { content: "Tipo de Evaluación"; }
        td:nth-of-type(4):before { content: "Identificador"; }
        td:nth-of-type(5):before { content: "Email"; }
        td:nth-of-type(6):before { content: "Categoría"; }
        td:nth-of-type(7):before { content: "Estado"; }
        td:nth-of-type(8):before { content: "URL"; }
        td:nth-of-type(9):before { content: "Descripción Actual"; }
        td:nth-of-type(10):before { content: "Descripción Humana"; }
      }
    </style>
  </head>
  <body>
    <h1>Appraisers Dashboard</h1>

    <!-- Botón de Google Sign-In -->
    <div id="g_id_onload"
         data-client_id="856401495068-ica4bncmu5t8i0muugrn9t8t25nt1hb4.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-shape="rectangular"
         data-theme="outline"
         data-text="sign_in_with"
         data-size="large"
         data-logo_alignment="left">
    </div>

    <!-- Contenedor para el Loader -->
    <div id="loader" style="display: none;"></div>

    <!-- Contenedor para mensajes de error o éxito -->
    <div id="message"></div>

    <!-- Contenedor para las evaluaciones -->
    <div id="appraisals"></div>

    <!-- Botón de Cerrar Sesión -->
    <button id="logout-button" style="display: none;">Cerrar Sesión</button>

    <script>
      // Función para mostrar mensajes
      function showMessage(type, text) {
        const messageDiv = document.getElementById('message');
        messageDiv.className = type === 'success' ? 'success' : 'error';
        messageDiv.innerText = text;
        messageDiv.style.display = 'block';
      }

      // Función para ocultar mensajes
      function hideMessage() {
        const messageDiv = document.getElementById('message');
        messageDiv.style.display = 'none';
      }

      // Función para manejar la respuesta del ID Token
      function handleCredentialResponse(response) {
        const idToken = response.credential;
        console.log("ID Token:", idToken);
        
        // Mostrar el loader mientras se realiza la autenticación
        document.getElementById('loader').style.display = 'block';
        hideMessage();
        
        // Enviar el ID token al backend para su validación y obtener el JWT
        fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/authenticate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ idToken })
        })
        .then(res => res.json())
        .then(data => {
          // Ocultar el loader después de recibir la respuesta
          document.getElementById('loader').style.display = 'none';
          
          if (data.success) {
            // Guardar el JWT en el almacenamiento local
            localStorage.setItem('jwtToken', data.token);
            // Mostrar el botón de cerrar sesión
            document.getElementById('logout-button').style.display = 'block';
            // Ocultar el botón de login
            document.querySelector('.g_id_signin').style.display = 'none';
            // Mostrar mensaje de éxito
            showMessage('success', 'Autenticación exitosa. Cargando evaluaciones...');
            // Proceder a cargar las evaluaciones
            loadAppraisals();
          } else {
            // Manejar el fallo de autenticación
            showMessage('error', 'Autenticación fallida. Por favor, intenta nuevamente.');
          }
        })
        .catch(err => {
          // Ocultar el loader en caso de error
          document.getElementById('loader').style.display = 'none';
          console.error('Error durante la autenticación:', err);
          showMessage('error', 'Error durante la autenticación. Por favor, intenta nuevamente.');
        });
      }

      // Función para cargar las evaluaciones desde el backend
      function loadAppraisals() {
        const jwtToken = localStorage.getItem('jwtToken');
        
        if (!jwtToken) {
          showMessage('error', 'No estás autenticado. Por favor, inicia sesión.');
          return;
        }

        // Mostrar el loader mientras se cargan las evaluaciones
        document.getElementById('loader').style.display = 'block';
        hideMessage();

        fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals', {
          headers: {
            'Authorization': `Bearer ${jwtToken}`
          }
        })
        .then(res => {
          // Ocultar el loader después de recibir la respuesta
          document.getElementById('loader').style.display = 'none';
          
          if (res.status === 401) {
            throw new Error('No autorizado. Por favor, inicia sesión nuevamente.');
          } else if (res.status === 403) {
            throw new Error('Acceso prohibido. No tienes permisos para ver este contenido.');
          }
          return res.json();
        })
        .then(data => {
          // Renderizar la lista de evaluaciones en el frontend
          const appraisalsDiv = document.getElementById('appraisals');
          if (data.length === 0) {
            appraisalsDiv.innerHTML = '<p>No hay evaluaciones pendientes.</p>';
            showMessage('success', 'No hay evaluaciones pendientes para mostrar.');
            return;
          }

          let tableHTML = `
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Fecha</th>
                  <th>Tipo de Evaluación</th>
                  <th>Identificador</th>
                  <th>Email</th>
                  <th>Categoría</th>
                  <th>Estado</th>
                  <th>URL</th>
                  <th>Descripción Actual</th>
                  <th>Descripción Humana</th>
                </tr>
              </thead>
              <tbody>
          `;

          data.forEach(appraisal => {
            tableHTML += `
              <tr>
                <td>${appraisal.id}</td>
                <td>${appraisal.date}</td>
                <td>${appraisal.appraisalType}</td>
                <td>${appraisal.identifier}</td>
                <td>${appraisal.email}</td>
                <td>${appraisal.category}</td>
                <td>${appraisal.status}</td>
                <td><a href="${appraisal.url}" target="_blank">Enlace</a></td>
                <td>${appraisal.currentDescription}</td>
                <td>${appraisal.humanDescription}</td>
              </tr>
            `;
          });

          tableHTML += `
              </tbody>
            </table>
          `;

          appraisalsDiv.innerHTML = tableHTML;
          showMessage('success', 'Evaluaciones cargadas exitosamente.');
        })
        .catch(err => {
          // Ocultar el loader en caso de error
          document.getElementById('loader').style.display = 'none';
          console.error('Error al obtener las evaluaciones:', err);
          showMessage('error', err.message || 'Error al obtener las evaluaciones.');
        });
      }

      // Función para cerrar sesión
      function logout() {
        // Mostrar el loader mientras se realiza el cierre de sesión
        document.getElementById('loader').style.display = 'block';
        hideMessage();

        fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/logout', {
          method: 'POST',
          credentials: 'include' // Incluir las cookies en la solicitud
        })
        .then(res => res.json())
        .then(data => {
          // Ocultar el loader después de recibir la respuesta
          document.getElementById('loader').style.display = 'none';
          
          if (data.success) {
            // Eliminar el JWT del almacenamiento local
            localStorage.removeItem('jwtToken');
            // Mostrar el botón de login
            document.querySelector('.g_id_signin').style.display = 'block';
            // Ocultar el botón de cerrar sesión
            document.getElementById('logout-button').style.display = 'none';
            // Limpiar las evaluaciones
            document.getElementById('appraisals').innerHTML = '';
            // Mostrar mensaje de éxito
            showMessage('success', 'Has cerrado sesión exitosamente.');
          } else {
            // Manejar el fallo al cerrar sesión
            showMessage('error', 'Error al cerrar sesión. Por favor, intenta nuevamente.');
          }
        })
        .catch(err => {
          // Ocultar el loader en caso de error
          document.getElementById('loader').style.display = 'none';
          console.error('Error al cerrar sesión:', err);
          showMessage('error', 'Error al cerrar sesión. Por favor, intenta nuevamente.');
        });
      }

      // Agregar evento al botón de cerrar sesión
      document.getElementById('logout-button').addEventListener('click', logout);

      // Verificar si el usuario ya está autenticado al cargar la página
      window.onload = () => {
        const jwtToken = localStorage.getItem('jwtToken');
        if (jwtToken) {
          // Mostrar el botón de cerrar sesión
          document.getElementById('logout-button').style.display = 'block';
          // Ocultar el botón de login
          document.querySelector('.g_id_signin').style.display = 'none';
          // Cargar las evaluaciones
          loadAppraisals();
        }
      };
    </script>
  </body>
</html>
