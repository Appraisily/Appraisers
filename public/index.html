<!-- public/index.html -->

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Appraisers Frontend</title>
    <!-- Load Google Identity Services Library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      /* Reset margins and paddings */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      /* Body Styles */
      body {
        font-family: 'Arial', sans-serif;
        background-color: #f9f9f9;
        color: #333333;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
        padding: 20px;
      }

      /* Main Container */
      .container {
        width: 100%;
        max-width: 800px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 40px 30px;
        text-align: center;
        margin-top: 50px;
      }

      /* Logo */
      .logo {
        margin-bottom: 20px;
      }

      .logo img {
        width: 150px;
        height: auto;
      }

      /* Title */
      .title {
        font-size: 24px;
        color: #333333;
        margin-bottom: 20px;
      }

      /* Sign-In Button */
      .g_id_signin {
        display: inline-block;
        margin-top: 20px;
      }

      /* Logout Button */
      #logout-button {
        margin-top: 30px;
        padding: 12px 24px;
        background-color: #d9534f;
        color: #ffffff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }

      #logout-button:hover {
        background-color: #c9302c;
      }

      /* Loader */
      #loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Success/Error Messages */
      #message {
        margin-top: 20px;
        padding: 15px 20px;
        border-radius: 4px;
        display: none;
        font-size: 16px;
      }

      #message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      #message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      /* Appraisals Table */
      #appraisals {
        margin-top: 30px;
        width: 100%;
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background-color: #ffffff;
        margin-bottom: 20px;
      }

      th, td {
        padding: 12px 15px;
        border: 1px solid #ddd;
        text-align: left;
      }

      th {
        background-color: #f4f4f4;
        color: #333333;
      }

      tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      /* Responsive Table */
      @media screen and (max-width: 600px) {
        table, thead, tbody, th, td, tr {
          display: block;
        }

        th {
          position: absolute;
          top: -9999px;
          left: -9999px;
        }

        tr {
          margin-bottom: 1rem;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 10px;
        }

        td {
          border: none;
          position: relative;
          padding-left: 50%;
          text-align: left;
        }

        td:before {
          position: absolute;
          top: 12px;
          left: 12px;
          width: 45%;
          padding-right: 10px;
          white-space: nowrap;
          font-weight: bold;
          content: attr(data-label);
          color: #555555;
        }
      }

      /* Footer */
      .footer {
        margin-top: auto;
        padding: 20px;
        text-align: center;
        font-size: 12px;
        color: #777777;
      }

      .footer a {
        color: #007bff;
        text-decoration: none;
      }

      .footer a:hover {
        text-decoration: underline;
      }

      /* Action Button */
      .action-button {
        padding: 8px 16px;
        background-color: #007bff;
        color: #ffffff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s ease;
        text-decoration: none;
      }

      .action-button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Logo -->
      <div class="logo">
        <a href="https://www.appraisily.com/" target="_blank">
          <img src="https://www.appraisily.com/wp-content/uploads/2023/12/cropped-appraisily.com_a_logo_for_an_online_art_and_antiques_appraisal__a8888b1f-2dbb-479e-9833-09c6263f0892.webp" alt="Appraisily Logo">
        </a>
      </div>

      <!-- Title -->
      <div class="title">Welcome to the Appraisers Dashboard</div>

      <!-- Success/Error Messages -->
      <div id="message"></div>

      <!-- Google Sign-In Button -->
      <div id="g_id_onload"
           data-client_id="856401495068-ica4bncmu5t8i0muugrn9t8t25nt1hb4.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin"
           data-type="standard"
           data-shape="rectangular"
           data-theme="outline"
           data-text="sign_in_with"
           data-size="large"
           data-logo_alignment="left">
      </div>

      <!-- Loader -->
      <div id="loader"></div>

      <!-- Appraisals Table -->
      <div id="appraisals"></div>

      <!-- Logout Button -->
      <button id="logout-button" style="display: none;">Logout</button>
    </div>

    <!-- Footer -->
    <div class="footer">
      Â© <span id="current-year"></span> Appraisily. All rights reserved.
    </div>

    <script>
      // Update the current year in the footer
      document.getElementById('current-year').textContent = new Date().getFullYear();

      // Function to show messages
      function showMessage(type, text) {
        const messageDiv = document.getElementById('message');
        messageDiv.className = type === 'success' ? 'success' : 'error';
        messageDiv.innerText = text;
        messageDiv.style.display = 'block';
      }

      // Function to hide messages
      function hideMessage() {
        const messageDiv = document.getElementById('message');
        messageDiv.style.display = 'none';
      }

      // Function to handle the ID Token response from Google
      function handleCredentialResponse(response) {
        const idToken = response.credential;
        console.log("ID Token:", idToken);
        
        // Show the loader while authenticating
        document.getElementById('loader').style.display = 'block';
        hideMessage();
        
        // Send the ID token to the backend for validation and to get a JWT
        fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/authenticate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ idToken })
        })
        .then(res => res.json())
        .then(data => {
          // Hide the loader after receiving the response
          document.getElementById('loader').style.display = 'none';
          
          if (data.success) {
            // Store the JWT in localStorage
            localStorage.setItem('jwtToken', data.token);
            // Show the logout button
            document.getElementById('logout-button').style.display = 'block';
            // Hide the sign-in button
            document.querySelector('.g_id_signin').style.display = 'none';
            // Show a success message
            showMessage('success', 'Authentication successful. Loading appraisals...');
            // Load the appraisals
            loadAppraisals();
          } else {
            // Handle authentication failure
            showMessage('error', 'Authentication failed. Please try again.');
          }
        })
        .catch(err => {
          // Hide the loader in case of error
          document.getElementById('loader').style.display = 'none';
          console.error('Authentication Error:', err);
          showMessage('error', 'Error during authentication. Please try again.');
        });
      }

      // Function to load appraisals from the backend
      function loadAppraisals() {
        const jwtToken = localStorage.getItem('jwtToken');
        
        if (!jwtToken) {
          showMessage('error', 'You are not authenticated. Please log in.');
          return;
        }

        // Show the loader while fetching appraisals
        document.getElementById('loader').style.display = 'block';
        hideMessage();

        fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals', {
          headers: {
            'Authorization': `Bearer ${jwtToken}`
          }
        })
        .then(res => {
          // Hide the loader after receiving the response
          document.getElementById('loader').style.display = 'none';
          
          if (res.status === 401) {
            throw new Error('Unauthorized. Please log in again.');
          } else if (res.status === 403) {
            throw new Error('Forbidden. You do not have permission to view this content.');
          }
          return res.json();
        })
        .then(data => {
          // Render the appraisals table
          const appraisalsDiv = document.getElementById('appraisals');
          if (data.length === 0) {
            appraisalsDiv.innerHTML = '<p>No pending appraisals.</p>';
            showMessage('success', 'No pending appraisals to display.');
            return;
          }

          let tableHTML = `
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Appraisal Type</th>
                  <th>Appraisal Number</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
          `;

          data.forEach(appraisal => {
            tableHTML += `
              <tr>
                <td data-label="Date">${appraisal.date}</td>
                <td data-label="Appraisal Type">${appraisal.appraisalType}</td>
                <td data-label="Appraisal Number">${appraisal.identifier}</td>
                <td data-label="Status">${appraisal.status}</td>
                <td data-label="Action">
                  <a href="appraisal.html?id=${appraisal.id}" class="action-button">Complete</a>
                </td>
              </tr>
            `;
          });

          tableHTML += `
              </tbody>
            </table>
          `;

          appraisalsDiv.innerHTML = tableHTML;
          showMessage('success', 'Appraisals loaded successfully.');
        })
        .catch(err => {
          // Hide the loader in case of error
          document.getElementById('loader').style.display = 'none';
          console.error('Error fetching appraisals:', err);
          showMessage('error', err.message || 'Error fetching appraisals.');
        });
      }

      // Function to handle logout
      function logout() {
        // Show the loader while logging out
        document.getElementById('loader').style.display = 'block';
        hideMessage();

        fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/logout', {
          method: 'POST',
          credentials: 'include' // Include cookies in the request
        })
        .then(res => res.json())
        .then(data => {
          // Hide the loader after receiving the response
          document.getElementById('loader').style.display = 'none';
          
          if (data.success) {
            // Remove the JWT from localStorage
            localStorage.removeItem('jwtToken');
            // Show the sign-in button
            document.querySelector('.g_id_signin').style.display = 'block';
            // Hide the logout button
            document.getElementById('logout-button').style.display = 'none';
            // Clear the appraisals table
            document.getElementById('appraisals').innerHTML = '';
            // Show a success message
            showMessage('success', 'You have been logged out successfully.');
          } else {
            // Handle logout failure
            showMessage('error', 'Error during logout. Please try again.');
          }
        })
        .catch(err => {
          // Hide the loader in case of error
          document.getElementById('loader').style.display = 'none';
          console.error('Logout Error:', err);
          showMessage('error', 'Error during logout. Please try again.');
        });
      }

      // Add event listener to the logout button
      document.getElementById('logout-button').addEventListener('click', logout);

      // Check if the user is already authenticated on page load
      window.onload = () => {
        const jwtToken = localStorage.getItem('jwtToken');
        if (jwtToken) {
          // Show the logout button
          document.getElementById('logout-button').style.display = 'block';
          // Hide the sign-in button
          document.querySelector('.g_id_signin').style.display = 'none';
          // Load the appraisals
          loadAppraisals();
        }
      };
    </script>
  </body>
</html>
