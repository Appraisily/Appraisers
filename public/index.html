<!-- public/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Appraisers Dashboard</title>
  <!-- Load Google Identity Services library -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Link to the external CSS file -->
<style>
  @import url('/public/css/styles.css');
  /* Additional page-specific styles */
</style>
  
</head>
<body>
  <!-- Logout Button -->
  <button id="logout-button" class="logout-button" style="display: none;">Logout</button>

  <!-- Div to display the user's name -->
  <div id="user-name" class="user-name" style="display: none;"></div>
  
  <div class="container">
    <!-- Logo -->
    <div class="logo">
      <a href="https://www.appraisily.com/" target="_blank">
        <img src="https://www.appraisily.com/wp-content/uploads/2023/12/cropped-appraisily.com_a_logo_for_an_online_art_and_antiques_appraisal__a8888b1f-2dbb-479e-9833-09c6263f0892.webp" alt="Appraisily Logo">
      </a>
    </div>

    <!-- Title -->
    <div class="title">Welcome to the Appraisers Dashboard</div>

    <!-- Success/Error Messages -->
    <div id="message"></div>

    <!-- Google Sign-In Button -->
    <div id="g_id_onload"
         data-client_id="856401495068-ica4bncmu5t8i0muugrn9t8t25nt1hb4.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div id="g_id_signin" class="g_id_signin"
         data-type="standard"
         data-shape="rectangular"
         data-theme="outline"
         data-text="sign_in_with"
         data-size="large"
         data-logo_alignment="left">
    </div>

    <!-- Loader -->
    <div id="loader"></div>

    <!-- Appraisals Container -->
    <div id="appraisals"></div>
  </div>

  <!-- Footer -->
  <div class="footer">
    Â© <span id="current-year"></span> Appraisily. All rights reserved.
  </div>

  <script>
    // Update the year in the footer
    document.getElementById('current-year').textContent = new Date().getFullYear();

    // Function to show messages
    function showMessage(type, text) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = type === 'success' ? 'success' : 'error';
      messageDiv.innerText = text;
      messageDiv.style.display = 'block';
    }

    // Function to hide messages
    function hideMessage() {
      const messageDiv = document.getElementById('message');
      messageDiv.style.display = 'none';
    }

    // Handle Google Sign-In credential response
    function handleCredentialResponse(response) {
      const idToken = response.credential;
      console.log("ID Token:", idToken);
      
      // Show the loader during authentication
      document.getElementById('loader').style.display = 'block';
      hideMessage();
      
      // Send the ID token to the backend for verification and JWT issuance
      fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/authenticate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ idToken }),
        credentials: 'include' // Include cookies in the request
      })
      .then(res => res.json())
      .then(data => {
        // Hide the loader after receiving the response
        document.getElementById('loader').style.display = 'none';
        
        if (data.success) {
          // Store the user's name
          const userName = data.name;
          localStorage.setItem('userName', data.name);

          // Show the logout button and hide the sign-in button
          document.getElementById('logout-button').style.display = 'block';
          document.getElementById('g_id_signin').style.display = 'none';

          // Show the user name
          showUserName(userName);

          // Show a success message
          showMessage('success', 'Authentication successful. Loading appraisals...');
          // Load the appraisals
          loadAppraisals();
        } else {
          // Handle authentication failure
          showMessage('error', data.message || 'Authentication failed. Please try again.');
        }
      })
      .catch(err => {
        // Hide the loader in case of error
        document.getElementById('loader').style.display = 'none';
        console.error('Error during authentication:', err);
        showMessage('error', 'Error during authentication. Please try again.');
      });
    }

    // Function to show the user's name
    function showUserName(name) {
      const userNameDiv = document.getElementById('user-name');
      userNameDiv.textContent = `Logged in as ${name}`;
      userNameDiv.style.display = 'block';
    }

    // Function to load appraisals from the backend
    function loadAppraisals() {
      // Show the loader while fetching appraisals
      document.getElementById('loader').style.display = 'block';
      hideMessage();

      fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include' // Include cookies in the request
      })
      .then(res => {
        // Hide the loader after receiving the response
        document.getElementById('loader').style.display = 'none';
        
        if (res.status === 401 || res.status === 403) {
          throw new Error('Unauthorized. Please log in again.');
        }
        return res.json();
      })
      .then(data => {
        // Show the logout button and hide the sign-in button
        document.getElementById('logout-button').style.display = 'block';
        document.getElementById('g_id_signin').style.display = 'none';

        // Render the appraisals table
        const appraisalsDiv = document.getElementById('appraisals');
        if (data.length === 0) {
          appraisalsDiv.innerHTML = '<p>No pending appraisals.</p>';
          showMessage('success', 'No pending appraisals to display.');
          return;
        }

        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Appraisal Type</th>
                <th>Appraisal Number</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
        `;

        data.forEach(appraisal => {
          tableHTML += `
            <tr>
              <td data-label="Date">${appraisal.date}</td>
              <td data-label="Appraisal Type">${appraisal.appraisalType}</td>
              <td data-label="Appraisal Number" title="${appraisal.identifier}">
                ${appraisal.identifier}
              </td>
              <td data-label="Status">${appraisal.status}</td>
              <td data-label="Action">
                <button class="action-button" data-id="${appraisal.id}" data-url="${appraisal.wordpressUrl}">Complete</button>
              </td>
            </tr>
          `;
        });

        tableHTML += `
            </tbody>
          </table>
        `;

        appraisalsDiv.innerHTML = tableHTML;
        showMessage('success', 'Appraisals loaded successfully.');

        // Add event listeners to the "Complete" buttons
        document.querySelectorAll('.action-button').forEach(button => {
          button.addEventListener('click', () => {
            const appraisalId = button.getAttribute('data-id');
            const wordpressUrl = button.getAttribute('data-url');
            // Redirect to the appraisal completion page with parameters
            window.location.href = `appraisal.html?id=${appraisalId}&wpUrl=${encodeURIComponent(wordpressUrl)}`;
          });
        });
      })
      .catch(err => {
        // Hide the loader in case of error
        document.getElementById('loader').style.display = 'none';
        console.error('Error fetching appraisals:', err);
        showMessage('error', err.message || 'Error fetching appraisals.');

        // Show the sign-in button and hide the logout button
        document.getElementById('logout-button').style.display = 'none';
        document.getElementById('g_id_signin').style.display = 'block';

        // Clear the appraisals
        document.getElementById('appraisals').innerHTML = '';
      });
    }

    // Function to handle logout
    function logout() {
      // Show the loader while logging out
      document.getElementById('loader').style.display = 'block';
      hideMessage();

      fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/logout', {
        method: 'POST',
        credentials: 'include' // Include cookies in the request
      })
      .then(res => res.json())
      .then(data => {
        // Hide the loader after receiving the response
        document.getElementById('loader').style.display = 'none';
        
        if (data.success) {
          // Show the sign-in button and hide the logout button
          document.getElementById('g_id_signin').style.display = 'block';
          document.getElementById('logout-button').style.display = 'none';
          
          // Clear the user's name from localStorage
          localStorage.removeItem('userName');
          
          // Hide the user name display
          document.getElementById('user-name').style.display = 'none';

          // Clear the appraisals
          document.getElementById('appraisals').innerHTML = '';
          // Show a success message
          showMessage('success', 'Successfully logged out.');
        } else {
          // Handle logout failure
          showMessage('error', 'Error logging out. Please try again.');
        }
      })
      .catch(err => {
        // Hide the loader in case of error
        document.getElementById('loader').style.display = 'none';
        console.error('Error during logout:', err);
        showMessage('error', 'Error logging out. Please try again.');
      });
    }

    // Add event listener to the logout button
    document.getElementById('logout-button').addEventListener('click', logout);

    // Check authentication status on page load
    window.onload = () => {
      // Check if the user's name is in localStorage
      const userName = localStorage.getItem('userName');
      
      if (userName) {
        // Show the logout button and hide the sign-in button
        document.getElementById('logout-button').style.display = 'block';
        document.getElementById('g_id_signin').style.display = 'none';

        // Show the user name display
        showUserName(userName);

        // Load the appraisals
        loadAppraisals();
      } else {
        // User not authenticated
        document.getElementById('logout-button').style.display = 'none';
        document.getElementById('g_id_signin').style.display = 'block';
      }
    };
  </script>
</body>
</html>
