<!-- public/index.html -->

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Appraisers Frontend</title>
    <!-- Cargar la biblioteca de Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      /* Reset de márgenes y paddings */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      /* Estilos del cuerpo */
      body {
        font-family: 'Arial', sans-serif;
        background-color: #f9f9f9;
        color: #333333;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
        padding: 20px;
      }

      /* Contenedor principal */
      .container {
        max-width: 800px; /* Aumentado para mejor visualización de la tabla */
        width: 100%;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 40px 30px;
        text-align: center;
        margin-top: 50px;
      }

      /* Logo */
      .logo {
        margin-bottom: 20px;
      }

      .logo img {
        width: 150px;
        height: auto;
      }

      /* Título */
      .title {
        font-size: 24px;
        color: #333333;
        margin-bottom: 20px;
      }

      /* Botón de Google Sign-In */
      .g_id_signin {
        display: inline-block;
        margin-top: 20px;
      }

      /* Botón de Cerrar Sesión */
      #logout-button {
        margin-top: 30px;
        padding: 12px 24px;
        background-color: #d9534f;
        color: #ffffff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }

      #logout-button:hover {
        background-color: #c9302c;
      }

      /* Loader */
      #loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Mensajes de Error/Éxito */
      #message {
        margin-top: 20px;
        padding: 15px 20px;
        border-radius: 4px;
        display: none;
        font-size: 16px;
      }

      #message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      #message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      /* Tabla de Evaluaciones */
      #appraisals {
        margin-top: 30px;
        width: 100%;
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background-color: #ffffff;
        margin-bottom: 20px;
      }

      th, td {
        padding: 12px 15px;
        border: 1px solid #ddd;
        text-align: left;
      }

      th {
        background-color: #f4f4f4;
        color: #333333;
      }

      tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      /* Botón de Acción en la Tabla */
      .action-button {
        padding: 8px 16px;
        background-color: #007bff;
        color: #ffffff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s ease;
      }

      .action-button:hover {
        background-color: #0056b3;
      }

      /* Responsive Table */
      @media screen and (max-width: 600px) {
        table, thead, tbody, th, td, tr {
          display: block;
        }

        th {
          position: absolute;
          top: -9999px;
          left: -9999px;
        }

        tr {
          margin-bottom: 1rem;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 10px;
        }

        td {
          border: none;
          position: relative;
          padding-left: 50%;
          text-align: left;
        }

        td:before {
          position: absolute;
          top: 12px;
          left: 12px;
          width: 45%;
          padding-right: 10px;
          white-space: nowrap;
          font-weight: bold;
          content: attr(data-label);
          color: #555555;
        }
      }

      /* Footer */
      .footer {
        margin-top: auto;
        padding: 20px;
        text-align: center;
        font-size: 12px;
        color: #777777;
      }

      .footer a {
        color: #007bff;
        text-decoration: none;
      }

      .footer a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Logo -->
      <div class="logo">
        <a href="https://www.appraisily.com/" target="_blank">
          <img src="https://www.appraisily.com/wp-content/uploads/2023/12/cropped-appraisily.com_a_logo_for_an_online_art_and_antiques_appraisal__a8888b1f-2dbb-479e-9833-09c6263f0892.webp" alt="Appraisily Logo">
        </a>
      </div>

      <!-- Título -->
      <div class="title">Bienvenido al Appraisers Dashboard</div>

      <!-- Mensajes de Error/Éxito -->
      <div id="message"></div>

      <!-- Botón de Google Sign-In -->
      <div id="g_id_onload"
           data-client_id="856401495068-ica4bncmu5t8i0muugrn9t8t25nt1hb4.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin"
           data-type="standard"
           data-shape="rectangular"
           data-theme="outline"
           data-text="sign_in_with"
           data-size="large"
           data-logo_alignment="left">
      </div>

      <!-- Loader -->
      <div id="loader"></div>

      <!-- Contenedor para las evaluaciones -->
      <div id="appraisals"></div>

      <!-- Botón de Cerrar Sesión -->
      <button id="logout-button" style="display: none;">Cerrar Sesión</button>
    </div>

    <!-- Footer -->
    <div class="footer">
      © <span id="current-year"></span> Appraisily. Todos los derechos reservados.
    </div>

    <script>
      // Actualizar el año en el footer
      document.getElementById('current-year').textContent = new Date().getFullYear();

      // Función para mostrar mensajes
      function showMessage(type, text) {
        const messageDiv = document.getElementById('message');
        messageDiv.className = type === 'success' ? 'success' : 'error';
        messageDiv.innerText = text;
        messageDiv.style.display = 'block';
      }

      // Función para ocultar mensajes
      function hideMessage() {
        const messageDiv = document.getElementById('message');
        messageDiv.style.display = 'none';
      }

      // Función para manejar la respuesta del ID Token
      function handleCredentialResponse(response) {
        const idToken = response.credential;
        console.log("ID Token:", idToken);
        
        // Mostrar el loader mientras se realiza la autenticación
        document.getElementById('loader').style.display = 'block';
        hideMessage();
        
        // Enviar el ID token al backend para su validación y obtener el JWT
        fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/authenticate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ idToken })
        })
        .then(res => res.json())
        .then(data => {
          // Ocultar el loader después de recibir la respuesta
          document.getElementById('loader').style.display = 'none';
          
          if (data.success && data.token) {
            // Guardar el JWT en el almacenamiento local
            localStorage.setItem('jwtToken', data.token);
            // Mostrar el botón de cerrar sesión
            document.getElementById('logout-button').style.display = 'block';
            // Ocultar el botón de login
            document.querySelector('.g_id_signin').style.display = 'none';
            // Mostrar mensaje de éxito
            showMessage('success', 'Autenticación exitosa. Cargando evaluaciones...');
            // Proceder a cargar las evaluaciones
            loadAppraisals();
          } else {
            // Manejar el fallo de autenticación
            showMessage('error', 'Autenticación fallida. Por favor, intenta nuevamente.');
          }
        })
        .catch(err => {
          // Ocultar el loader en caso de error
          document.getElementById('loader').style.display = 'none';
          console.error('Error durante la autenticación:', err);
          showMessage('error', 'Error durante la autenticación. Por favor, intenta nuevamente.');
        });
      }

      // Función para cargar las evaluaciones desde el backend
      function loadAppraisals() {
        const jwtToken = localStorage.getItem('jwtToken');
        
        if (!jwtToken) {
          showMessage('error', 'No estás autenticado. Por favor, inicia sesión.');
          return;
        }

        // Mostrar el loader mientras se cargan las evaluaciones
        document.getElementById('loader').style.display = 'block';
        hideMessage();

        fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals', {
          headers: {
            'Authorization': `Bearer ${jwtToken}`
          }
        })
        .then(res => {
          // Ocultar el loader después de recibir la respuesta
          document.getElementById('loader').style.display = 'none';
          
          if (res.status === 401) {
            throw new Error('No autorizado. Por favor, inicia sesión nuevamente.');
          } else if (res.status === 403) {
            throw new Error('Acceso prohibido. No tienes permisos para ver este contenido.');
          }
          return res.json();
        })
        .then(data => {
          // Renderizar la lista de evaluaciones en el frontend
          const appraisalsDiv = document.getElementById('appraisals');
          if (data.length === 0) {
            appraisalsDiv.innerHTML = '<p>No hay evaluaciones pendientes.</p>';
            showMessage('success', 'No hay evaluaciones pendientes para mostrar.');
            return;
          }

          let tableHTML = `
            <table>
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Tipo de Evaluación</th>
                  <th>Número de Evaluación</th>
                  <th>Estado</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody>
          `;

          data.forEach(appraisal => {
            tableHTML += `
              <tr>
                <td data-label="Fecha">${appraisal.date}</td>
                <td data-label="Tipo de Evaluación">${appraisal.appraisalType}</td>
                <td data-label="Número de Evaluación">${appraisal.identifier}</td>
                <td data-label="Estado">${appraisal.status}</td>
                <td data-label="Acción">
                  <button class="action-button" onclick="openAppraisal(${appraisal.id})">Completar</button>
                </td>
              </tr>
            `;
          });

          tableHTML += `
              </tbody>
            </table>
          `;

          appraisalsDiv.innerHTML = tableHTML;
          showMessage('success', 'Evaluaciones cargadas exitosamente.');
        })
        .catch(err => {
          // Ocultar el loader en caso de error
          document.getElementById('loader').style.display = 'none';
          console.error('Error al obtener las evaluaciones:', err);
          showMessage('error', err.message || 'Error al obtener las evaluaciones.');
        });
      }

      // Función para abrir la página de completar evaluación
      function openAppraisal(id) {
        // Redireccionar a una nueva página con el ID de la evaluación como parámetro
        window.location.href = `appraisal.html?id=${id}`;
      }

      // Función para cerrar sesión
      function logout() {
        // Mostrar el loader mientras se realiza el cierre de sesión
        document.getElementById('loader').style.display = 'block';
        hideMessage();

        fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/logout', {
          method: 'POST'
          // No se requieren credenciales ya que el backend no usa cookies
        })
        .then(res => res.json())
        .then(data => {
          // Ocultar el loader después de recibir la respuesta
          document.getElementById('loader').style.display = 'none';
          
          if (data.success) {
            // Eliminar el JWT del almacenamiento local
            localStorage.removeItem('jwtToken');
            // Mostrar el botón de login
            document.querySelector('.g_id_signin').style.display = 'block';
            // Ocultar el botón de cerrar sesión
            document.getElementById('logout-button').style.display = 'none';
            // Limpiar las evaluaciones
            document.getElementById('appraisals').innerHTML = '';
            // Mostrar mensaje de éxito
            showMessage('success', 'Has cerrado sesión exitosamente.');
          } else {
            // Manejar el fallo al cerrar sesión
            showMessage('error', 'Error al cerrar sesión. Por favor, intenta nuevamente.');
          }
        })
        .catch(err => {
          // Ocultar el loader en caso de error
          document.getElementById('loader').style.display = 'none';
          console.error('Error al cerrar sesión:', err);
          showMessage('error', 'Error al cerrar sesión. Por favor, intenta nuevamente.');
        });
      }

      // Agregar evento al botón de cerrar sesión
      document.getElementById('logout-button').addEventListener('click', logout);

      // Verificar si el usuario ya está autenticado al cargar la página
      window.onload = () => {
        const jwtToken = localStorage.getItem('jwtToken');
        if (jwtToken) {
          // Mostrar el botón de cerrar sesión
          document.getElementById('logout-button').style.display = 'block';
          // Ocultar el botón de login
          document.querySelector('.g_id_signin').style.display = 'none';
          // Cargar las evaluaciones
          loadAppraisals();
        }
      };
    </script>
  </body>
</html>
