<!-- public/index.html -->

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Appraisers Frontend</title>
  <!-- Cargar la librería de Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  @import url('css/styles.css');
</style>
</head>
<body>
  <!-- Botón de Cerrar Sesión -->
  <button id="logout-button" class="logout-button" style="display: none;">Cerrar Sesión</button>

  <div class="container">
    <!-- Logo -->
    <div class="logo">
      <a href="https://www.appraisily.com/" target="_blank">
        <img src="https://www.appraisily.com/wp-content/uploads/2023/12/cropped-appraisily.com_a_logo_for_an_online_art_and_antiques_appraisal__a8888b1f-2dbb-479e-9833-09c6263f0892.webp" alt="Appraisily Logo">
      </a>
    </div>

    <!-- Título -->
    <div class="title">Bienvenido al Appraisers Dashboard</div>

    <!-- Mensajes de Error/Éxito -->
    <div id="message"></div>

    <!-- Botón de Iniciar Sesión de Google -->
    <div id="g_id_onload"
         data-client_id="856401495068-ica4bncmu5t8i0muugrn9t8t25nt1hb4.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div id="g_id_signin" class="g_id_signin"
         data-type="standard"
         data-shape="rectangular"
         data-theme="outline"
         data-text="sign_in_with"
         data-size="large"
         data-logo_alignment="left">
    </div>

    <!-- Loader -->
    <div id="loader"></div>

    <!-- Contenedor de Evaluaciones -->
    <div id="appraisals"></div>
  </div>

  <!-- Pie de página -->
  <div class="footer">
    © <span id="current-year"></span> Appraisily. Todos los derechos reservados.
  </div>

  <script>
    // Actualizar el año en el pie de página
    document.getElementById('current-year').textContent = new Date().getFullYear();

    // Función para mostrar mensajes
    function showMessage(type, text) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = type === 'success' ? 'success' : 'error';
      messageDiv.innerText = text;
      messageDiv.style.display = 'block';
    }

    // Función para ocultar mensajes
    function hideMessage() {
      const messageDiv = document.getElementById('message');
      messageDiv.style.display = 'none';
    }

    // Manejar la respuesta de credenciales de Google Sign-In
 function handleCredentialResponse(response) {
  const idToken = response.credential;
  console.log("ID Token:", idToken);
  
  // Mostrar el loader durante la autenticación
  document.getElementById('loader').style.display = 'block';
  hideMessage();
  
  // Enviar el ID token al backend para verificación y emisión de JWT
  fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/authenticate', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ idToken }),
    credentials: 'include' // Incluir cookies en la solicitud
  })
  .then(res => res.json())
  .then(data => {
    // Ocultar el loader después de recibir la respuesta
    document.getElementById('loader').style.display = 'none';
    
    if (data.success) {
      // **Almacenar el nombre del usuario**
      const userName = data.name;

      // Mostrar el botón de cerrar sesión y ocultar el botón de iniciar sesión
      document.getElementById('logout-button').style.display = 'block';
      document.getElementById('g_id_signin').style.display = 'none';

      // **Mostrar el mensaje de usuario conectado**
      showUserName(userName);

      // Mostrar un mensaje de éxito
      showMessage('success', 'Autenticación exitosa. Cargando evaluaciones...');
      // Cargar las evaluaciones
      loadAppraisals();
    } else {
      // Manejar la falla en la autenticación
      showMessage('error', data.message || 'Autenticación fallida. Por favor, intenta nuevamente.');
    }
  })
  .catch(err => {
    // Ocultar el loader en caso de error
    document.getElementById('loader').style.display = 'none';
    console.error('Error durante la autenticación:', err);
    showMessage('error', 'Error durante la autenticación. Por favor, intenta nuevamente.');
  });
}

// Función para mostrar el nombre del usuario
function showUserName(name) {
  const userNameDiv = document.getElementById('user-name');
  userNameDiv.textContent = `Estás conectado como ${name}`;
  userNameDiv.style.display = 'block';
}

    

    // Función para cargar evaluaciones desde el backend
    function loadAppraisals() {
      // Mostrar el loader mientras se obtienen las evaluaciones
      document.getElementById('loader').style.display = 'block';
      hideMessage();

      fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/appraisals', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include' // Incluir cookies en la solicitud
      })
      .then(res => {
        // Ocultar el loader después de recibir la respuesta
        document.getElementById('loader').style.display = 'none';
        
        if (res.status === 401 || res.status === 403) {
          throw new Error('No autorizado. Por favor, inicia sesión nuevamente.');
        }
        return res.json();
      })
      .then(data => {
        // Mostrar el botón de cerrar sesión y ocultar el botón de iniciar sesión
        document.getElementById('logout-button').style.display = 'block';
        document.getElementById('g_id_signin').style.display = 'none';

        // Renderizar la tabla de evaluaciones
        const appraisalsDiv = document.getElementById('appraisals');
        if (data.length === 0) {
          appraisalsDiv.innerHTML = '<p>No hay evaluaciones pendientes.</p>';
          showMessage('success', 'No hay evaluaciones pendientes para mostrar.');
          return;
        }

        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Appraisal Type</th>
                <th>Appraisal Number</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
        `;

        data.forEach(appraisal => {
          tableHTML += `
            <tr>
              <td data-label="Date">${appraisal.date}</td>
              <td data-label="Appraisal Type">${appraisal.appraisalType}</td>
              <td data-label="Appraisal Number" title="${appraisal.identifier}">
                ${appraisal.identifier}
              </td>
              <td data-label="Status">${appraisal.status}</td>
              <td data-label="Action">
                <button class="action-button" data-id="${appraisal.id}" data-url="${appraisal.wordpressUrl}">Complete</button>
              </td>
            </tr>
          `;
        });

        tableHTML += `
            </tbody>
          </table>
        `;

        appraisalsDiv.innerHTML = tableHTML;
        showMessage('success', 'Evaluaciones cargadas exitosamente.');

        // Añadir event listeners a los botones "Complete"
        document.querySelectorAll('.action-button').forEach(button => {
          button.addEventListener('click', () => {
            const appraisalId = button.getAttribute('data-id');
            const wordpressUrl = button.getAttribute('data-url');
            // Redirigir a la página de completar evaluación con los parámetros
            window.location.href = `appraisal.html?id=${appraisalId}&wpUrl=${encodeURIComponent(wordpressUrl)}`;
          });
        });
      })
      .catch(err => {
        // Ocultar el loader en caso de error
        document.getElementById('loader').style.display = 'none';
        console.error('Error al obtener las evaluaciones:', err);
        showMessage('error', err.message || 'Error al obtener las evaluaciones.');

        // Mostrar el botón de iniciar sesión y ocultar el botón de cerrar sesión
        document.getElementById('logout-button').style.display = 'none';
        document.getElementById('g_id_signin').style.display = 'block';

        // Limpiar las evaluaciones
        document.getElementById('appraisals').innerHTML = '';
      });
    }

    // Función para manejar el cierre de sesión
    function logout() {
      // Mostrar el loader mientras se cierra sesión
      document.getElementById('loader').style.display = 'block';
      hideMessage();

      fetch('https://appraisers-backend-856401495068.us-central1.run.app/api/logout', {
        method: 'POST',
        credentials: 'include' // Incluir cookies en la solicitud
      })
      .then(res => res.json())
    .then(data => {
  // Ocultar el loader después de recibir la respuesta
  document.getElementById('loader').style.display = 'none';
  
  if (data.success) {
    // Mostrar el botón de iniciar sesión y ocultar el botón de cerrar sesión
    document.getElementById('g_id_signin').style.display = 'block';
    document.getElementById('logout-button').style.display = 'none';
    
    // **Ocultar el mensaje del nombre del usuario**
    document.getElementById('user-name').style.display = 'none';

    // Limpiar las evaluaciones
    document.getElementById('appraisals').innerHTML = '';
    // Mostrar un mensaje de éxito
    showMessage('success', 'Has cerrado sesión exitosamente.');
  } else {
    // Manejar la falla al cerrar sesión
    showMessage('error', 'Error al cerrar sesión. Por favor, intenta nuevamente.');
  }
})


    // Añadir event listener al botón de cerrar sesión
    document.getElementById('logout-button').addEventListener('click', logout);

    // Verificar el estado de autenticación al cargar la página
    window.onload = () => {
      // Intentar cargar las evaluaciones; la función manejará la autenticación
      loadAppraisals();
    };
  </script>
</body>
</html>
